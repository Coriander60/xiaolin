# 3.2 HTTP/1.1 如何优化？

- [3.2 HTTP/1.1 如何优化？](#32-http11-如何优化)
  - [如何避免发送 HTTP 请求？](#如何避免发送-http-请求)
  - [如何减少 HTTP 请求次数？](#如何减少-http-请求次数)
    - [减少重定向请求次数](#减少重定向请求次数)
    - [合并请求](#合并请求)
    - [延迟发送请求](#延迟发送请求)
  - [如何减少 HTTP 响应的数据大小？](#如何减少-http-响应的数据大小)
    - [无损压缩](#无损压缩)
    - [有损压缩](#有损压缩)


问你一句：「**你知道 HTTP/1.1 该如何优化吗？**」

- *尽量避免发送 HTTP 请求*；
- *在需要发送 HTTP 请求时，考虑如何减少请求次数*；
- *减少服务器的 HTTP 响应的数据大小*；

---

## 如何避免发送 HTTP 请求？

缓存

客户端会把第一次请求以及响应的数据保存到本地，其中将请求的 URL 作为 key，而响应作为 value。

后续请求先查本地缓存


```text
         用户访问资源
              ↓
 检查强制缓存是否过期（max-age / expires）
              ↓
       ┌─────────────┐   
     没过期         过期      
       ↓             ↓
   用缓存        发协商请求（之前的响应头中带 ETag 或 Last-Modified）
                            ↓
         服务端比较是否修改（请求头中用 If-None-Match 或 If-Modified-Since）
                            ↓
                    ┌───────────────┐
                  未修改          有修改
                    ↓               ↓         
                   304             200 
                继续用缓存        用新资源    

```

## 如何减少 HTTP 请求次数？

减少 HTTP 请求次数自然也就提升了 HTTP 性能，可以从这 3 个方面入手：

- *减少重定向请求次数*；
- *合并请求*；
- *延迟发送请求*；

### 减少重定向请求次数

将原本由客户端处理的重定向请求，交给代理服务器处理，这样可以减少重定向请求的次数；

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/网络/http1.1优化/客户端重定向.png)


如果**重定向的工作交由代理服务器完成，就能减少 HTTP 请求次数了**，如下图：

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/网络/http1.1优化/代理服务器重定向.png)

而且当代理服务器知晓了重定向规则后，可以进一步减少消息传递次数，如下图：

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/网络/http1.1优化/代理服务器重定向2.png)

除了 `302` 重定向响应码，还有其他一些重定向的响应码，你可以从下图看到：

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/网络/http1.1优化/重定向响应码.png)

其中，`301` 和 `308` 响应码是告诉客户端可以将重定向响应缓存到本地磁盘，之后客户端就自动用 url2 替代 url1 访问服务器的资源。



### 合并请求

把多个访问小文件的请求合并成一个大的请求，**减少了重复发送的 HTTP 头部**。

为了防止单个请求的阻塞，所以**一般浏览器会同时发起 5-6 个请求，每一个请求都是不同的 TCP 连接**，那么如果合并了请求，也就会**减少 TCP 连接的数量，因而省去了  TCP 握手和慢启动过程耗费的时间**。

>例如：精灵图(sprites)、base64

但是这样的合并请求会带来新的问题，**当大资源中的某一个小资源发生变化后，客户端必须重新下载整个完整的大资源文件**，这显然带来了额外的网络消耗。


### 延迟发送请求

懒加载，在页面加载时只加载当前需要的资源，延迟加载那些“暂时看不到”的资源


## 如何减少 HTTP 响应的数据大小？

压缩

### 无损压缩

无损压缩是指资源经过压缩后，信息不被破坏，还能完全恢复到压缩前的原样，适合用在文本文件、程序可执行文件、程序源代码。

对原始资源建立统计模型，利用这个统计模型，将常出现的数据用较短的二进制比特序列表示，将不常出现的数据用较长的二进制比特序列表示

生成二进制比特序列一般是「霍夫曼编码」算法。


```plain
# 请求头 声明客户端支持的压缩格式
Accept-Encoding: gzip, deflate, br
# 响应头 声明服务器使用的压缩格式
Content-Encoding: br
```

### 有损压缩

解压的数据会与原始数据不同但是非常接近。

有损压缩主要将次要的数据舍弃，牺牲一些质量来减少数据量、提高压缩比，这种方法经常用于压缩多媒体数据，比如音频、视频、图片。

可以通过 HTTP 请求头部中的 `Accept` 字段里的「q 质量因子」，告诉服务器期望的资源质量。

```plain
Accept: audio/*; q=0.2, audio/basic
```

关于音视频的压缩，每个帧都有时序的关系，通常时间连续的帧之间的变化是很小的。

>比如，一个在看书的视频，画面通常只有人物的手和书桌上的书是会有变化的，而其他地方通常都是静态的，于是只需要在一个静态的关键帧，使用**增量数据**来表达后续的帧，这样便减少了很多数据，提高了网络传输的性能。对于视频常见的编码格式有 H264、H265 等，音频常见的编码格式有 AAC、AC3。

