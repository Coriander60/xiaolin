# Redis å¸¸è§æ•°æ®ç±»åž‹å’Œåº”ç”¨åœºæ™¯

ðŸš©Redis å¸¸è§çš„æ•°æ®ç±»åž‹ï¼ˆ5+4ï¼‰ï¼š

**Stringï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼ŒHashï¼ˆå“ˆå¸Œï¼‰ï¼ŒListï¼ˆåˆ—è¡¨ï¼‰ï¼ŒSetï¼ˆé›†åˆï¼‰ã€Zsetï¼ˆæœ‰åºé›†åˆï¼‰**ã€‚

**BitMapï¼ˆ2.2 ç‰ˆæ–°å¢žï¼‰ã€HyperLogLogï¼ˆ2.8 ç‰ˆæ–°å¢žï¼‰ã€GEOï¼ˆ3.2 ç‰ˆæ–°å¢žï¼‰ã€Streamï¼ˆ5.0 ç‰ˆæ–°å¢žï¼‰**ã€‚

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/æ•°æ®ç±»åž‹/rediså‘½ä»¤æçº².png)

## String

### ä»‹ç»

String æ˜¯æœ€åŸºæœ¬çš„ key-value ç»“æž„ï¼Œkey æ˜¯å”¯ä¸€æ ‡è¯†ï¼Œvalue æ˜¯å…·ä½“çš„å€¼ï¼Œvalue å…¶å®žä¸ä»…æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯æ•°å­—ï¼ˆæ•´æ•°æˆ–æµ®ç‚¹æ•°ï¼‰ï¼Œvalue æœ€å¤šå¯ä»¥å®¹çº³çš„æ•°æ®é•¿åº¦æ˜¯ `512M`ã€‚

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/æ•°æ®ç±»åž‹/string.png)

### å†…éƒ¨å®žçŽ°

String ç±»åž‹çš„åº•å±‚çš„æ•°æ®ç»“æž„å®žçŽ°ä¸»è¦æ˜¯ int å’Œ SDSï¼ˆç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼‰ã€‚

```c
// SDS å¤´éƒ¨å®šä¹‰ï¼ˆä»¥ 8 ä½ä¸ºä¾‹ï¼‰
struct __attribute__ ((__packed__)) sdshdr8 {
    uint8_t len;    // å½“å‰å·²ä½¿ç”¨çš„é•¿åº¦
    uint8_t alloc;  // æ€»å…±åˆ†é…çš„ buf é•¿åº¦ï¼ˆä¸å«å¤´éƒ¨ï¼‰
    char buf[];     // å®žé™…ä¿å­˜æ•°æ®çš„åœ°æ–¹ï¼ˆflexible arrayï¼‰
};
```

SDS å’Œæˆ‘ä»¬è®¤è¯†çš„ C å­—ç¬¦ä¸²ä¸å¤ªä¸€æ ·ï¼Œä¹‹æ‰€ä»¥æ²¡æœ‰ä½¿ç”¨ C è¯­è¨€çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œå› ä¸º SDS ç›¸æ¯”äºŽ C çš„åŽŸç”Ÿå­—ç¬¦ä¸²ï¼š

- **SDS  ä¸ä»…å¯ä»¥ä¿å­˜æ–‡æœ¬æ•°æ®ï¼Œè¿˜å¯ä»¥ä¿å­˜äºŒè¿›åˆ¶æ•°æ®**ã€‚å› ä¸º `SDS` ä½¿ç”¨ `len` å±žæ€§çš„å€¼è€Œä¸æ˜¯ç©ºå­—ç¬¦æ¥åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ç»“æŸï¼Œå¹¶ä¸” SDS çš„æ‰€æœ‰ API éƒ½ä¼šä»¥å¤„ç†äºŒè¿›åˆ¶çš„æ–¹å¼æ¥å¤„ç† SDS å­˜æ”¾åœ¨ `buf[]` æ•°ç»„é‡Œçš„æ•°æ®ã€‚æ‰€ä»¥ SDS ä¸å…‰èƒ½å­˜æ”¾æ–‡æœ¬æ•°æ®ï¼Œè€Œä¸”èƒ½ä¿å­˜å›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘ã€åŽ‹ç¼©æ–‡ä»¶è¿™æ ·çš„äºŒè¿›åˆ¶æ•°æ®ã€‚
- **SDS èŽ·å–å­—ç¬¦ä¸²é•¿åº¦çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(1)**ã€‚å› ä¸º C è¯­è¨€çš„å­—ç¬¦ä¸²å¹¶ä¸è®°å½•è‡ªèº«é•¿åº¦ï¼Œæ‰€ä»¥èŽ·å–é•¿åº¦çš„å¤æ‚åº¦ä¸º O(n)ï¼›è€Œ SDS ç»“æž„é‡Œç”¨ `len` å±žæ€§è®°å½•äº†å­—ç¬¦ä¸²é•¿åº¦ï¼Œæ‰€ä»¥å¤æ‚åº¦ä¸º `O(1)`ã€‚
- **Redis çš„ SDS API æ˜¯å®‰å…¨çš„ï¼Œæ‹¼æŽ¥å­—ç¬¦ä¸²ä¸ä¼šé€ æˆç¼“å†²åŒºæº¢å‡º**ã€‚å› ä¸º SDS åœ¨æ‹¼æŽ¥å­—ç¬¦ä¸²ä¹‹å‰ä¼šæ£€æŸ¥ SDS ç©ºé—´æ˜¯å¦æ»¡è¶³è¦æ±‚ï¼Œå¦‚æžœç©ºé—´ä¸å¤Ÿä¼šè‡ªåŠ¨æ‰©å®¹ï¼Œæ‰€ä»¥ä¸ä¼šå¯¼è‡´ç¼“å†²åŒºæº¢å‡ºçš„é—®é¢˜ã€‚

å­—ç¬¦ä¸²å¯¹è±¡çš„å†…éƒ¨ç¼–ç ï¼ˆencodingï¼‰æœ‰ 3 ç§ï¼š**intã€raw å’Œ embstr**ã€‚
```c
typedef struct redisObject {
    unsigned type;     // è¡¨ç¤ºå¯¹è±¡çš„ç±»åž‹ï¼Œæ¯”å¦‚ stringã€listã€set
    unsigned encoding; // è¡¨ç¤ºå¯¹è±¡çš„å†…éƒ¨ç¼–ç æ–¹å¼ï¼Œæ¯”å¦‚ rawã€intã€embstr
    void *ptr;         // æŒ‡å‘å®žé™…æ•°æ®ï¼ˆæˆ–è€…ç›´æŽ¥å­˜æ”¾æ•°æ®çš„åœ°æ–¹ï¼‰
} robj;

robj *o;
```

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/æ•°æ®ç±»åž‹/stringç»“æž„.png)

å¦‚æžœä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„æ˜¯æ•´æ•°å€¼ï¼Œå¹¶ä¸”è¿™ä¸ªæ•´æ•°å€¼å¯ä»¥ç”¨`long`ç±»åž‹æ¥è¡¨ç¤ºï¼Œé‚£ä¹ˆå­—ç¬¦ä¸²å¯¹è±¡ä¼šå°†æ•´æ•°å€¼ä¿å­˜åœ¨å­—ç¬¦ä¸²å¯¹è±¡ç»“æž„çš„`ptr`å±žæ€§é‡Œé¢ï¼ˆå°†`void*`è½¬æ¢æˆ longï¼‰ï¼Œå¹¶å°†å­—ç¬¦ä¸²å¯¹è±¡çš„ç¼–ç è®¾ç½®ä¸º`int`ã€‚

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/æ•°æ®ç±»åž‹/int.png)

å¦‚æžœå­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¹¶ä¸”è¿™ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦å°äºŽç­‰äºŽ 32 å­—èŠ‚ï¼ˆredis 2.+ç‰ˆæœ¬ï¼‰ï¼Œé‚£ä¹ˆå­—ç¬¦ä¸²å¯¹è±¡å°†ä½¿ç”¨ä¸€ä¸ªç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰æ¥ä¿å­˜è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œå¹¶å°†å¯¹è±¡çš„ç¼–ç è®¾ç½®ä¸º`embstr`ï¼Œ `embstr`ç¼–ç æ˜¯ä¸“é—¨ç”¨äºŽä¿å­˜çŸ­å­—ç¬¦ä¸²çš„ä¸€ç§ä¼˜åŒ–ç¼–ç æ–¹å¼ï¼š

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/æ•°æ®ç±»åž‹/embstr.png)

å¦‚æžœå­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¹¶ä¸”è¿™ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦å¤§äºŽ 32 å­—èŠ‚ï¼ˆredis 2.+ç‰ˆæœ¬ï¼‰ï¼Œé‚£ä¹ˆå­—ç¬¦ä¸²å¯¹è±¡å°†ä½¿ç”¨ä¸€ä¸ªç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰æ¥ä¿å­˜è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œå¹¶å°†å¯¹è±¡çš„ç¼–ç è®¾ç½®ä¸º`raw`ï¼š

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/æ•°æ®ç±»åž‹/raw.png)

æ³¨æ„ï¼Œembstr ç¼–ç å’Œ raw ç¼–ç çš„è¾¹ç•Œåœ¨ redis ä¸åŒç‰ˆæœ¬ä¸­æ˜¯ä¸ä¸€æ ·çš„ï¼š

- redis 2.+ æ˜¯ 32 å­—èŠ‚
- redis 3.0-4.0 æ˜¯ 39 å­—èŠ‚
- redis 5.0 æ˜¯ 44 å­—èŠ‚

å¯ä»¥çœ‹åˆ°`embstr`å’Œ`raw`ç¼–ç éƒ½ä¼šä½¿ç”¨`SDS`æ¥ä¿å­˜å€¼ï¼Œä½†ä¸åŒä¹‹å¤„åœ¨äºŽ`embstr`ä¼šé€šè¿‡ä¸€æ¬¡å†…å­˜åˆ†é…å‡½æ•°æ¥åˆ†é…ä¸€å—è¿žç»­çš„å†…å­˜ç©ºé—´æ¥ä¿å­˜`redisObject`å’Œ`SDS`ï¼Œè€Œ`raw`ç¼–ç ä¼šé€šè¿‡è°ƒç”¨ä¸¤æ¬¡å†…å­˜åˆ†é…å‡½æ•°æ¥åˆ†åˆ«åˆ†é…ä¸¤å—ç©ºé—´æ¥ä¿å­˜`redisObject`å’Œ`SDS`ã€‚Redis è¿™æ ·åšä¼šæœ‰å¾ˆå¤šå¥½å¤„ï¼š

- `embstr`ç¼–ç å°†åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡æ‰€éœ€çš„å†…å­˜åˆ†é…æ¬¡æ•°ä»Ž `raw` ç¼–ç çš„ä¸¤æ¬¡é™ä½Žä¸ºä¸€æ¬¡ï¼›
- é‡Šæ”¾ `embstr`ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡åŒæ ·åªéœ€è¦è°ƒç”¨ä¸€æ¬¡å†…å­˜é‡Šæ”¾å‡½æ•°ï¼›
- å› ä¸º`embstr`ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡çš„æ‰€æœ‰æ•°æ®éƒ½ä¿å­˜åœ¨ä¸€å—è¿žç»­çš„å†…å­˜é‡Œé¢å¯ä»¥æ›´å¥½çš„åˆ©ç”¨ CPU ç¼“å­˜æå‡æ€§èƒ½ã€‚

ä½†æ˜¯ embstr ä¹Ÿæœ‰ç¼ºç‚¹çš„ï¼š

- å¦‚æžœå­—ç¬¦ä¸²çš„é•¿åº¦å¢žåŠ éœ€è¦é‡æ–°åˆ†é…å†…å­˜æ—¶ï¼Œæ•´ä¸ª redisObject å’Œ sds éƒ½éœ€è¦é‡æ–°åˆ†é…ç©ºé—´ï¼Œæ‰€ä»¥**embstr ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡å®žé™…ä¸Šæ˜¯åªè¯»çš„**ï¼Œredis æ²¡æœ‰ä¸º embstr ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡ç¼–å†™ä»»ä½•ç›¸åº”çš„ä¿®æ”¹ç¨‹åºã€‚å½“æˆ‘ä»¬å¯¹ embstr ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡æ‰§è¡Œä»»ä½•ä¿®æ”¹å‘½ä»¤ï¼ˆä¾‹å¦‚ appendï¼‰æ—¶ï¼Œç¨‹åºä¼šå…ˆå°†å¯¹è±¡çš„ç¼–ç ä»Ž embstr è½¬æ¢æˆ rawï¼Œç„¶åŽå†æ‰§è¡Œä¿®æ”¹å‘½ä»¤ã€‚

### å¸¸ç”¨æŒ‡ä»¤

æ™®é€šå­—ç¬¦ä¸²çš„åŸºæœ¬æ“ä½œï¼š

```shell
# è®¾ç½® key-value ç±»åž‹çš„å€¼
> SET name lin
OK
# æ ¹æ® key èŽ·å¾—å¯¹åº”çš„ value
> GET name
"lin"
# åˆ¤æ–­æŸä¸ª key æ˜¯å¦å­˜åœ¨
> EXISTS name
(integer) 1
# è¿”å›ž key æ‰€å‚¨å­˜çš„å­—ç¬¦ä¸²å€¼çš„é•¿åº¦
> STRLEN name
(integer) 3
# åˆ é™¤æŸä¸ª key å¯¹åº”çš„å€¼
> DEL name
(integer) 1
```

æ‰¹é‡è®¾ç½® :

```shell
# æ‰¹é‡è®¾ç½® key-value ç±»åž‹çš„å€¼
> MSET key1 value1 key2 value2 
OK
# æ‰¹é‡èŽ·å–å¤šä¸ª key å¯¹åº”çš„ value
> MGET key1 key2 
1) "value1"
2) "value2"
```

è®¡æ•°å™¨ï¼ˆå­—ç¬¦ä¸²çš„å†…å®¹ä¸ºæ•´æ•°çš„æ—¶å€™å¯ä»¥ä½¿ç”¨ï¼‰ï¼š

```shell
# è®¾ç½® key-value ç±»åž‹çš„å€¼
> SET number 0
OK
# å°† key ä¸­å‚¨å­˜çš„æ•°å­—å€¼å¢žä¸€
> INCR number
(integer) 1
# å°†keyä¸­å­˜å‚¨çš„æ•°å­—å€¼åŠ  10
> INCRBY number 10
(integer) 11
# å°† key ä¸­å‚¨å­˜çš„æ•°å­—å€¼å‡ä¸€
> DECR number
(integer) 10
# å°†keyä¸­å­˜å‚¨çš„æ•°å­—å€¼é”® 10
> DECRBY number 10
(integer) 0
```

è¿‡æœŸï¼ˆé»˜è®¤ä¸ºæ°¸ä¸è¿‡æœŸï¼‰ï¼š

```bash
# è®¾ç½® key åœ¨ 60 ç§’åŽè¿‡æœŸï¼ˆè¯¥æ–¹æ³•æ˜¯é’ˆå¯¹å·²ç»å­˜åœ¨çš„keyè®¾ç½®è¿‡æœŸæ—¶é—´ï¼‰
> EXPIRE name  60 
(integer) 1
# æŸ¥çœ‹æ•°æ®è¿˜æœ‰å¤šä¹…è¿‡æœŸ
> TTL name 
(integer) 51

#è®¾ç½® key-value ç±»åž‹çš„å€¼ï¼Œå¹¶è®¾ç½®è¯¥keyçš„è¿‡æœŸæ—¶é—´ä¸º 60 ç§’
> SET key  value EX 60
OK
> SETEX key  60 value
OK
```

ä¸å­˜åœ¨å°±æ’å…¥ï¼š

```shell
# ä¸å­˜åœ¨å°±æ’å…¥ï¼ˆnot existsï¼‰
>SETNX key value
(integer) 1
```

### åº”ç”¨åœºæ™¯

#### ç¼“å­˜å¯¹è±¡

ä½¿ç”¨ String æ¥ç¼“å­˜å¯¹è±¡æœ‰ä¸¤ç§æ–¹å¼ï¼š

- ç›´æŽ¥ç¼“å­˜æ•´ä¸ªå¯¹è±¡çš„ JSONï¼Œå‘½ä»¤ä¾‹å­ï¼š `SET user:1 '{"name":"xiaolin", "age":18}'`ã€‚
- é‡‡ç”¨å°† key è¿›è¡Œåˆ†ç¦»ä¸º user:ID:å±žæ€§ï¼Œé‡‡ç”¨ MSET å­˜å‚¨ï¼Œç”¨ MGET èŽ·å–å„å±žæ€§å€¼ï¼Œå‘½ä»¤ä¾‹å­ï¼š `MSET user:1:name xiaolin user:1:age 18 user:2:name xiaomei user:2:age 20`ã€‚

#### å¸¸è§„è®¡æ•°

å› ä¸º Redis å¤„ç†å‘½ä»¤æ˜¯å•çº¿ç¨‹ï¼Œæ‰€ä»¥æ‰§è¡Œå‘½ä»¤çš„è¿‡ç¨‹æ˜¯åŽŸå­çš„ã€‚å› æ­¤ String æ•°æ®ç±»åž‹é€‚åˆè®¡æ•°åœºæ™¯ï¼Œæ¯”å¦‚è®¡ç®—è®¿é—®æ¬¡æ•°ã€ç‚¹èµžã€è½¬å‘ã€åº“å­˜æ•°é‡ç­‰ç­‰ã€‚

æ¯”å¦‚è®¡ç®—æ–‡ç« çš„é˜…è¯»é‡ï¼š

```shell
# åˆå§‹åŒ–æ–‡ç« çš„é˜…è¯»é‡
> SET aritcle:readcount:1001 0
OK
#é˜…è¯»é‡+1
> INCR aritcle:readcount:1001
(integer) 1
#é˜…è¯»é‡+1
> INCR aritcle:readcount:1001
(integer) 2
#é˜…è¯»é‡+1
> INCR aritcle:readcount:1001
(integer) 3
# èŽ·å–å¯¹åº”æ–‡ç« çš„é˜…è¯»é‡
> GET aritcle:readcount:1001
"3"
```

#### åˆ†å¸ƒå¼é”

SET å‘½ä»¤æœ‰ä¸ª NX å‚æ•°å¯ä»¥å®žçŽ°ã€Œkey ä¸å­˜åœ¨æ‰æ’å…¥ã€ï¼Œå¯ä»¥ç”¨å®ƒæ¥å®žçŽ°åˆ†å¸ƒå¼é”ï¼š

- å¦‚æžœ key ä¸å­˜åœ¨ï¼Œåˆ™æ˜¾ç¤ºæ’å…¥æˆåŠŸï¼Œå¯ä»¥ç”¨æ¥è¡¨ç¤ºåŠ é”æˆåŠŸï¼›
- å¦‚æžœ key å­˜åœ¨ï¼Œåˆ™ä¼šæ˜¾ç¤ºæ’å…¥å¤±è´¥ï¼Œå¯ä»¥ç”¨æ¥è¡¨ç¤ºåŠ é”å¤±è´¥ã€‚

ä¸€èˆ¬è€Œè¨€ï¼Œè¿˜ä¼šå¯¹åˆ†å¸ƒå¼é”åŠ ä¸Šè¿‡æœŸæ—¶é—´ï¼Œåˆ†å¸ƒå¼é”çš„å‘½ä»¤å¦‚ä¸‹ï¼š

```shell
SET lock_key unique_value NX PX 10000
```

- lock_key å°±æ˜¯ key é”®ï¼›
- unique_value æ˜¯å®¢æˆ·ç«¯ç”Ÿæˆçš„å”¯ä¸€çš„æ ‡è¯†ï¼›
- NX ä»£è¡¨åªåœ¨ lock_key ä¸å­˜åœ¨æ—¶ï¼Œæ‰å¯¹ lock_key è¿›è¡Œè®¾ç½®æ“ä½œï¼›
- PX 10000 è¡¨ç¤ºè®¾ç½® lock_key çš„è¿‡æœŸæ—¶é—´ä¸º 10sï¼Œè¿™æ˜¯ä¸ºäº†é¿å…å®¢æˆ·ç«¯å‘ç”Ÿå¼‚å¸¸è€Œæ— æ³•é‡Šæ”¾é”ã€‚

è€Œè§£é”çš„è¿‡ç¨‹å°±æ˜¯å°† lock_key é”®åˆ é™¤ï¼Œä½†ä¸èƒ½ä¹±åˆ ï¼Œè¦ä¿è¯æ‰§è¡Œæ“ä½œçš„å®¢æˆ·ç«¯å°±æ˜¯åŠ é”çš„å®¢æˆ·ç«¯ã€‚æ‰€ä»¥ï¼Œè§£é”çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦å…ˆåˆ¤æ–­é”çš„ unique_value æ˜¯å¦ä¸ºåŠ é”å®¢æˆ·ç«¯ï¼Œæ˜¯çš„è¯ï¼Œæ‰å°† lock_key é”®åˆ é™¤ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œè§£é”æ˜¯æœ‰ä¸¤ä¸ªæ“ä½œï¼Œè¿™æ—¶å°±éœ€è¦ Lua è„šæœ¬æ¥ä¿è¯è§£é”çš„åŽŸå­æ€§ï¼Œå› ä¸º Redis åœ¨æ‰§è¡Œ Lua è„šæœ¬æ—¶ï¼Œå¯ä»¥ä»¥åŽŸå­æ€§çš„æ–¹å¼æ‰§è¡Œï¼Œä¿è¯äº†é”é‡Šæ”¾æ“ä½œçš„åŽŸå­æ€§ã€‚

```Lua
// é‡Šæ”¾é”æ—¶ï¼Œå…ˆæ¯”è¾ƒ unique_value æ˜¯å¦ç›¸ç­‰ï¼Œé¿å…é”çš„è¯¯é‡Šæ”¾
if redis.call("get",KEYS[1]) == ARGV[1] then
    return redis.call("del",KEYS[1])
else
    return 0
end
```

è¿™æ ·ä¸€æ¥ï¼Œå°±é€šè¿‡ä½¿ç”¨ SET å‘½ä»¤å’Œ Lua è„šæœ¬åœ¨ Redis å•èŠ‚ç‚¹ä¸Šå®Œæˆäº†åˆ†å¸ƒå¼é”çš„åŠ é”å’Œè§£é”ã€‚

#### å…±äº« Session ä¿¡æ¯

é€šå¸¸æˆ‘ä»¬åœ¨å¼€å‘åŽå°ç®¡ç†ç³»ç»Ÿæ—¶ï¼Œä¼šä½¿ç”¨ Session æ¥ä¿å­˜ç”¨æˆ·çš„ä¼šè¯ (ç™»å½•) çŠ¶æ€ï¼Œè¿™äº› Session ä¿¡æ¯ä¼šè¢«ä¿å­˜åœ¨æœåŠ¡å™¨ç«¯ï¼Œä½†è¿™åªé€‚ç”¨äºŽå•ç³»ç»Ÿåº”ç”¨ï¼Œå¦‚æžœæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿæ­¤æ¨¡å¼å°†ä¸å†é€‚ç”¨ã€‚

ä¾‹å¦‚ç”¨æˆ·ä¸€çš„ Session ä¿¡æ¯è¢«å­˜å‚¨åœ¨æœåŠ¡å™¨ä¸€ï¼Œä½†ç¬¬äºŒæ¬¡è®¿é—®æ—¶ç”¨æˆ·ä¸€è¢«åˆ†é…åˆ°æœåŠ¡å™¨äºŒï¼Œè¿™ä¸ªæ—¶å€™æœåŠ¡å™¨å¹¶æ²¡æœ‰ç”¨æˆ·ä¸€çš„ Session ä¿¡æ¯ï¼Œå°±ä¼šå‡ºçŽ°éœ€è¦é‡å¤ç™»å½•çš„é—®é¢˜ï¼Œé—®é¢˜åœ¨äºŽåˆ†å¸ƒå¼ç³»ç»Ÿæ¯æ¬¡ä¼šæŠŠè¯·æ±‚éšæœºåˆ†é…åˆ°ä¸åŒçš„æœåŠ¡å™¨ã€‚

åˆ†å¸ƒå¼ç³»ç»Ÿå•ç‹¬å­˜å‚¨ Session æµç¨‹å›¾ï¼š

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/æ•°æ®ç±»åž‹/Session1.png)

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å€ŸåŠ© Redis å¯¹è¿™äº› Session ä¿¡æ¯è¿›è¡Œç»Ÿä¸€çš„å­˜å‚¨å’Œç®¡ç†ï¼Œè¿™æ ·æ— è®ºè¯·æ±‚å‘é€åˆ°é‚£å°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨éƒ½ä¼šåŽ»åŒä¸€ä¸ª Redis èŽ·å–ç›¸å…³çš„ Session ä¿¡æ¯ï¼Œè¿™æ ·å°±è§£å†³äº†åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ Session å­˜å‚¨çš„é—®é¢˜ã€‚

åˆ†å¸ƒå¼ç³»ç»Ÿä½¿ç”¨åŒä¸€ä¸ª Redis å­˜å‚¨ Session æµç¨‹å›¾ï¼š

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/æ•°æ®ç±»åž‹/Session2.png)

## List

### ä»‹ç»

List åˆ—è¡¨æ˜¯ç®€å•çš„å­—ç¬¦ä¸²åˆ—è¡¨ï¼Œ**æŒ‰ç…§æ’å…¥é¡ºåºæŽ’åº**ï¼Œå¯ä»¥ä»Žå¤´éƒ¨æˆ–å°¾éƒ¨å‘ List åˆ—è¡¨æ·»åŠ å…ƒç´ ã€‚

åˆ—è¡¨çš„æœ€å¤§é•¿åº¦ä¸º `2^32 - 1`ï¼Œä¹Ÿå³æ¯ä¸ªåˆ—è¡¨æ”¯æŒè¶…è¿‡ `40 äº¿`ä¸ªå…ƒç´ ã€‚

### å†…éƒ¨å®žçŽ°

List ç±»åž‹çš„åº•å±‚æ•°æ®ç»“æž„æ˜¯ç”±**åŒå‘é“¾è¡¨æˆ–åŽ‹ç¼©åˆ—è¡¨**å®žçŽ°çš„ï¼š

- å¦‚æžœåˆ—è¡¨çš„å…ƒç´ ä¸ªæ•°å°äºŽ `512` ä¸ªï¼ˆé»˜è®¤å€¼ï¼Œå¯ç”± `list-max-ziplist-entries` é…ç½®ï¼‰ï¼Œåˆ—è¡¨æ¯ä¸ªå…ƒç´ çš„å€¼éƒ½å°äºŽ `64` å­—èŠ‚ï¼ˆé»˜è®¤å€¼ï¼Œå¯ç”± `list-max-ziplist-value` é…ç½®ï¼‰ï¼ŒRedis ä¼šä½¿ç”¨**åŽ‹ç¼©åˆ—è¡¨**ä½œä¸º List ç±»åž‹çš„åº•å±‚æ•°æ®ç»“æž„ï¼›
- å¦‚æžœåˆ—è¡¨çš„å…ƒç´ ä¸æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶ï¼ŒRedis ä¼šä½¿ç”¨**åŒå‘é“¾è¡¨**ä½œä¸º List ç±»åž‹çš„åº•å±‚æ•°æ®ç»“æž„ï¼›

ä½†æ˜¯**åœ¨ Redis 3.2 ç‰ˆæœ¬ä¹‹åŽï¼ŒList æ•°æ®ç±»åž‹åº•å±‚æ•°æ®ç»“æž„å°±åªç”± quicklist å®žçŽ°äº†ï¼Œæ›¿ä»£äº†åŒå‘é“¾è¡¨å’ŒåŽ‹ç¼©åˆ—è¡¨**ã€‚

### å¸¸ç”¨å‘½ä»¤

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/æ•°æ®ç±»åž‹/list.png)

```shell
# å°†ä¸€ä¸ªæˆ–å¤šä¸ªå€¼valueæ’å…¥åˆ°keyåˆ—è¡¨çš„è¡¨å¤´(æœ€å·¦è¾¹)ï¼Œæœ€åŽçš„å€¼åœ¨æœ€å‰é¢
LPUSH key value [value ...] 
# å°†ä¸€ä¸ªæˆ–å¤šä¸ªå€¼valueæ’å…¥åˆ°keyåˆ—è¡¨çš„è¡¨å°¾(æœ€å³è¾¹)
RPUSH key value [value ...]
# ç§»é™¤å¹¶è¿”å›žkeyåˆ—è¡¨çš„å¤´å…ƒç´ 
LPOP key     
# ç§»é™¤å¹¶è¿”å›žkeyåˆ—è¡¨çš„å°¾å…ƒç´ 
RPOP key 

# è¿”å›žåˆ—è¡¨keyä¸­æŒ‡å®šåŒºé—´å†…çš„å…ƒç´ ï¼ŒåŒºé—´ä»¥åç§»é‡startå’ŒstopæŒ‡å®šï¼Œä»Ž0å¼€å§‹
LRANGE key start stop

# ä»Žkeyåˆ—è¡¨è¡¨å¤´å¼¹å‡ºä¸€ä¸ªå…ƒç´ ï¼Œæ²¡æœ‰å°±é˜»å¡žtimeoutç§’ï¼Œå¦‚æžœtimeout=0åˆ™ä¸€ç›´é˜»å¡ž
BLPOP key [key ...] timeout
# ä»Žkeyåˆ—è¡¨è¡¨å°¾å¼¹å‡ºä¸€ä¸ªå…ƒç´ ï¼Œæ²¡æœ‰å°±é˜»å¡žtimeoutç§’ï¼Œå¦‚æžœtimeout=0åˆ™ä¸€ç›´é˜»å¡ž
BRPOP key [key ...] timeout
```

### åº”ç”¨åœºæ™¯

#### æ¶ˆæ¯é˜Ÿåˆ—

æ¶ˆæ¯é˜Ÿåˆ—åœ¨å­˜å–æ¶ˆæ¯æ—¶ï¼Œå¿…é¡»è¦æ»¡è¶³ä¸‰ä¸ªéœ€æ±‚ï¼Œåˆ†åˆ«æ˜¯**æ¶ˆæ¯ä¿åºã€å¤„ç†é‡å¤çš„æ¶ˆæ¯å’Œä¿è¯æ¶ˆæ¯å¯é æ€§**ã€‚

Redis çš„ List å’Œ Stream ä¸¤ç§æ•°æ®ç±»åž‹ï¼Œå°±å¯ä»¥æ»¡è¶³æ¶ˆæ¯é˜Ÿåˆ—çš„è¿™ä¸‰ä¸ªéœ€æ±‚ã€‚æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹åŸºäºŽ List çš„æ¶ˆæ¯é˜Ÿåˆ—å®žçŽ°æ–¹æ³•ï¼ŒåŽé¢åœ¨ä»‹ç» Stream æ•°æ®ç±»åž‹æ—¶å€™ï¼Œåœ¨è¯¦ç»†è¯´è¯´ Streamã€‚

*1ã€å¦‚ä½•æ»¡è¶³æ¶ˆæ¯ä¿åºéœ€æ±‚ï¼Ÿ*

List æœ¬èº«å°±æ˜¯æŒ‰å…ˆè¿›å…ˆå‡ºçš„é¡ºåºå¯¹æ•°æ®è¿›è¡Œå­˜å–çš„ï¼Œæ‰€ä»¥ï¼Œå¦‚æžœä½¿ç”¨ List ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ä¿å­˜æ¶ˆæ¯çš„è¯ï¼Œå°±å·²ç»èƒ½æ»¡è¶³æ¶ˆæ¯ä¿åºçš„éœ€æ±‚äº†ã€‚

List å¯ä»¥ä½¿ç”¨ LPUSH + RPOPï¼ˆæˆ–è€…åè¿‡æ¥ï¼ŒRPUSH+LPOPï¼‰å‘½ä»¤å®žçŽ°æ¶ˆæ¯é˜Ÿåˆ—ã€‚

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/æ•°æ®ç±»åž‹/listæ¶ˆæ¯é˜Ÿåˆ—.png)

- ç”Ÿäº§è€…ä½¿ç”¨ `LPUSH key value[value...]` å°†æ¶ˆæ¯æ’å…¥åˆ°é˜Ÿåˆ—çš„å¤´éƒ¨ï¼Œå¦‚æžœ key ä¸å­˜åœ¨åˆ™ä¼šåˆ›å»ºä¸€ä¸ªç©ºçš„é˜Ÿåˆ—å†æ’å…¥æ¶ˆæ¯ã€‚

- æ¶ˆè´¹è€…ä½¿ç”¨ `RPOP key` ä¾æ¬¡è¯»å–é˜Ÿåˆ—çš„æ¶ˆæ¯ï¼Œå…ˆè¿›å…ˆå‡ºã€‚

ä¸è¿‡ï¼Œåœ¨æ¶ˆè´¹è€…è¯»å–æ•°æ®æ—¶ï¼Œæœ‰ä¸€ä¸ªæ½œåœ¨çš„æ€§èƒ½é£Žé™©ç‚¹ã€‚

åœ¨ç”Ÿäº§è€…å¾€ List ä¸­å†™å…¥æ•°æ®æ—¶ï¼ŒList å¹¶ä¸ä¼šä¸»åŠ¨åœ°é€šçŸ¥æ¶ˆè´¹è€…æœ‰æ–°æ¶ˆæ¯å†™å…¥ï¼Œå¦‚æžœæ¶ˆè´¹è€…æƒ³è¦åŠæ—¶å¤„ç†æ¶ˆæ¯ï¼Œå°±éœ€è¦åœ¨ç¨‹åºä¸­ä¸åœåœ°è°ƒç”¨ `RPOP` å‘½ä»¤ï¼ˆæ¯”å¦‚ä½¿ç”¨ä¸€ä¸ª while(1) å¾ªçŽ¯ï¼‰ã€‚å¦‚æžœæœ‰æ–°æ¶ˆæ¯å†™å…¥ï¼ŒRPOP å‘½ä»¤å°±ä¼šè¿”å›žç»“æžœï¼Œå¦åˆ™ï¼ŒRPOP å‘½ä»¤è¿”å›žç©ºå€¼ï¼Œå†ç»§ç»­å¾ªçŽ¯ã€‚

æ‰€ä»¥ï¼Œå³ä½¿æ²¡æœ‰æ–°æ¶ˆæ¯å†™å…¥ Listï¼Œæ¶ˆè´¹è€…ä¹Ÿè¦ä¸åœåœ°è°ƒç”¨ RPOP å‘½ä»¤ï¼Œè¿™å°±ä¼šå¯¼è‡´æ¶ˆè´¹è€…ç¨‹åºçš„ CPU ä¸€ç›´æ¶ˆè€—åœ¨æ‰§è¡Œ RPOP å‘½ä»¤ä¸Šï¼Œå¸¦æ¥ä¸å¿…è¦çš„æ€§èƒ½æŸå¤±ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedis æä¾›äº† BRPOP å‘½ä»¤ã€‚**BRPOP å‘½ä»¤ä¹Ÿç§°ä¸ºé˜»å¡žå¼è¯»å–ï¼Œå®¢æˆ·ç«¯åœ¨æ²¡æœ‰è¯»åˆ°é˜Ÿåˆ—æ•°æ®æ—¶ï¼Œè‡ªåŠ¨é˜»å¡žï¼Œç›´åˆ°æœ‰æ–°çš„æ•°æ®å†™å…¥é˜Ÿåˆ—ï¼Œå†å¼€å§‹è¯»å–æ–°æ•°æ®**ã€‚å’Œæ¶ˆè´¹è€…ç¨‹åºè‡ªå·±ä¸åœåœ°è°ƒç”¨ RPOP å‘½ä»¤ç›¸æ¯”ï¼Œè¿™ç§æ–¹å¼èƒ½èŠ‚çœ CPU å¼€é”€ã€‚

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/æ•°æ®ç±»åž‹/æ¶ˆæ¯é˜Ÿåˆ—.png)

*2ã€å¦‚ä½•å¤„ç†é‡å¤çš„æ¶ˆæ¯ï¼Ÿ*

æ¶ˆè´¹è€…è¦å®žçŽ°é‡å¤æ¶ˆæ¯çš„åˆ¤æ–­ï¼Œéœ€è¦ 2 ä¸ªæ–¹é¢çš„è¦æ±‚ï¼š

- æ¯ä¸ªæ¶ˆæ¯éƒ½æœ‰ä¸€ä¸ªå…¨å±€çš„ IDã€‚
- æ¶ˆè´¹è€…è¦è®°å½•å·²ç»å¤„ç†è¿‡çš„æ¶ˆæ¯çš„ IDã€‚å½“æ”¶åˆ°ä¸€æ¡æ¶ˆæ¯åŽï¼Œæ¶ˆè´¹è€…ç¨‹åºå°±å¯ä»¥å¯¹æ¯”æ”¶åˆ°çš„æ¶ˆæ¯ ID å’Œè®°å½•çš„å·²å¤„ç†è¿‡çš„æ¶ˆæ¯ IDï¼Œæ¥åˆ¤æ–­å½“å‰æ”¶åˆ°çš„æ¶ˆæ¯æœ‰æ²¡æœ‰ç»è¿‡å¤„ç†ã€‚å¦‚æžœå·²ç»å¤„ç†è¿‡ï¼Œé‚£ä¹ˆï¼Œæ¶ˆè´¹è€…ç¨‹åºå°±ä¸å†è¿›è¡Œå¤„ç†äº†ã€‚

ä½†æ˜¯ **List å¹¶ä¸ä¼šä¸ºæ¯ä¸ªæ¶ˆæ¯ç”Ÿæˆ ID å·ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªè¡Œä¸ºæ¯ä¸ªæ¶ˆæ¯ç”Ÿæˆä¸€ä¸ªå…¨å±€å”¯ä¸€ ID**ï¼Œç”Ÿæˆä¹‹åŽï¼Œæˆ‘ä»¬åœ¨ç”¨ LPUSH å‘½ä»¤æŠŠæ¶ˆæ¯æ’å…¥ List æ—¶ï¼Œéœ€è¦åœ¨æ¶ˆæ¯ä¸­åŒ…å«è¿™ä¸ªå…¨å±€å”¯ä¸€ IDã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå°±æŠŠä¸€æ¡å…¨å±€ ID ä¸º 111000102ã€åº“å­˜é‡ä¸º 99 çš„æ¶ˆæ¯æ’å…¥äº†æ¶ˆæ¯é˜Ÿåˆ—ï¼š

```shell
> LPUSH mq "111000102:stock:99"
(integer) 1
```

*3ã€å¦‚ä½•ä¿è¯æ¶ˆæ¯å¯é æ€§ï¼Ÿ*

å½“æ¶ˆè´¹è€…ç¨‹åºä»Ž List ä¸­è¯»å–ä¸€æ¡æ¶ˆæ¯åŽï¼ŒList å°±ä¸ä¼šå†ç•™å­˜è¿™æ¡æ¶ˆæ¯äº†ã€‚æ‰€ä»¥ï¼Œå¦‚æžœæ¶ˆè´¹è€…ç¨‹åºåœ¨å¤„ç†æ¶ˆæ¯çš„è¿‡ç¨‹å‡ºçŽ°äº†æ•…éšœæˆ–å®•æœºï¼Œå°±ä¼šå¯¼è‡´æ¶ˆæ¯æ²¡æœ‰å¤„ç†å®Œæˆï¼Œé‚£ä¹ˆï¼Œæ¶ˆè´¹è€…ç¨‹åºå†æ¬¡å¯åŠ¨åŽï¼Œå°±æ²¡æ³•å†æ¬¡ä»Ž List ä¸­è¯»å–æ¶ˆæ¯äº†ã€‚

ä¸ºäº†ç•™å­˜æ¶ˆæ¯ï¼ŒList ç±»åž‹æä¾›äº† `BRPOPLPUSH` å‘½ä»¤ï¼Œè¿™ä¸ªå‘½ä»¤çš„**ä½œç”¨æ˜¯è®©æ¶ˆè´¹è€…ç¨‹åºä»Žä¸€ä¸ª List ä¸­è¯»å–æ¶ˆæ¯ï¼ŒåŒæ—¶ï¼ŒRedis ä¼šæŠŠè¿™ä¸ªæ¶ˆæ¯å†æ’å…¥åˆ°å¦ä¸€ä¸ª Listï¼ˆå¯ä»¥å«ä½œå¤‡ä»½ Listï¼‰ç•™å­˜**ã€‚

è¿™æ ·ä¸€æ¥ï¼Œå¦‚æžœæ¶ˆè´¹è€…ç¨‹åºè¯»äº†æ¶ˆæ¯ä½†æ²¡èƒ½æ­£å¸¸å¤„ç†ï¼Œç­‰å®ƒé‡å¯åŽï¼Œå°±å¯ä»¥ä»Žå¤‡ä»½ List ä¸­é‡æ–°è¯»å–æ¶ˆæ¯å¹¶è¿›è¡Œå¤„ç†äº†ã€‚

å¥½äº†ï¼Œåˆ°è¿™é‡Œå¯ä»¥çŸ¥é“åŸºäºŽ List ç±»åž‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ»¡è¶³æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸‰å¤§éœ€æ±‚ï¼ˆæ¶ˆæ¯ä¿åºã€å¤„ç†é‡å¤çš„æ¶ˆæ¯å’Œä¿è¯æ¶ˆæ¯å¯é æ€§ï¼‰ã€‚

- æ¶ˆæ¯ä¿åºï¼šä½¿ç”¨ LPUSH + RPOPï¼›
- é˜»å¡žè¯»å–ï¼šä½¿ç”¨ BRPOPï¼›
- é‡å¤æ¶ˆæ¯å¤„ç†ï¼šç”Ÿäº§è€…è‡ªè¡Œå®žçŽ°å…¨å±€å”¯ä¸€ IDï¼›
- æ¶ˆæ¯çš„å¯é æ€§ï¼šä½¿ç”¨ BRPOPLPUSH

> List ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—æœ‰ä»€ä¹ˆç¼ºé™·ï¼Ÿ

**List ä¸æ”¯æŒå¤šä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹åŒä¸€æ¡æ¶ˆæ¯**ï¼Œå› ä¸ºä¸€æ—¦æ¶ˆè´¹è€…æ‹‰å–ä¸€æ¡æ¶ˆæ¯åŽï¼Œè¿™æ¡æ¶ˆæ¯å°±ä»Ž List ä¸­åˆ é™¤äº†ï¼Œæ— æ³•è¢«å…¶å®ƒæ¶ˆè´¹è€…å†æ¬¡æ¶ˆè´¹ã€‚

è¦å®žçŽ°ä¸€æ¡æ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œé‚£ä¹ˆå°±è¦å°†å¤šä¸ªæ¶ˆè´¹è€…ç»„æˆä¸€ä¸ªæ¶ˆè´¹ç»„ï¼Œä½¿å¾—å¤šä¸ªæ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹åŒä¸€æ¡æ¶ˆæ¯ï¼Œä½†æ˜¯ **List ç±»åž‹å¹¶ä¸æ”¯æŒæ¶ˆè´¹ç»„çš„å®žçŽ°**ã€‚

è¿™å°±è¦è¯´èµ· Redis ä»Ž 5.0 ç‰ˆæœ¬å¼€å§‹æä¾›çš„ Stream æ•°æ®ç±»åž‹äº†ï¼ŒStream åŒæ ·èƒ½å¤Ÿæ»¡è¶³æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸‰å¤§éœ€æ±‚ï¼Œè€Œä¸”å®ƒè¿˜æ”¯æŒã€Œæ¶ˆè´¹ç»„ã€å½¢å¼çš„æ¶ˆæ¯è¯»å–ã€‚

## Hash

### ä»‹ç»

Hash æ˜¯ä¸€ä¸ªé”®å€¼å¯¹ï¼ˆkey - valueï¼‰é›†åˆï¼Œå…¶ä¸­ value çš„å½¢å¼å¦‚ï¼š `value=[{field1ï¼Œvalue1}ï¼Œ...{fieldNï¼ŒvalueN}]`ã€‚Hash ç‰¹åˆ«é€‚åˆç”¨äºŽå­˜å‚¨å¯¹è±¡ã€‚ 

Hash ä¸Ž String å¯¹è±¡çš„åŒºåˆ«å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/æ•°æ®ç±»åž‹/hash.png)

### å†…éƒ¨å®žçŽ°

Hash ç±»åž‹çš„åº•å±‚æ•°æ®ç»“æž„æ˜¯ç”±**åŽ‹ç¼©åˆ—è¡¨æˆ–å“ˆå¸Œè¡¨**å®žçŽ°çš„ï¼š

- å¦‚æžœå“ˆå¸Œç±»åž‹å…ƒç´ ä¸ªæ•°å°äºŽ `512` ä¸ªï¼ˆé»˜è®¤å€¼ï¼Œå¯ç”± `hash-max-ziplist-entries` é…ç½®ï¼‰ï¼Œæ‰€æœ‰å€¼å°äºŽ `64` å­—èŠ‚ï¼ˆé»˜è®¤å€¼ï¼Œå¯ç”± `hash-max-ziplist-value` é…ç½®ï¼‰çš„è¯ï¼ŒRedis ä¼šä½¿ç”¨**åŽ‹ç¼©åˆ—è¡¨**ä½œä¸º Hash ç±»åž‹çš„åº•å±‚æ•°æ®ç»“æž„ï¼›
- å¦‚æžœå“ˆå¸Œç±»åž‹å…ƒç´ ä¸æ»¡è¶³ä¸Šé¢æ¡ä»¶ï¼ŒRedis ä¼šä½¿ç”¨**å“ˆå¸Œè¡¨**ä½œä¸º Hash ç±»åž‹çš„ åº•å±‚æ•°æ®ç»“æž„ã€‚

**åœ¨ Redis 7.0 ä¸­ï¼ŒåŽ‹ç¼©åˆ—è¡¨æ•°æ®ç»“æž„å·²ç»åºŸå¼ƒäº†ï¼Œäº¤ç”± listpack æ•°æ®ç»“æž„æ¥å®žçŽ°äº†**ã€‚

### å¸¸ç”¨å‘½ä»¤

```shell
# å­˜å‚¨ä¸€ä¸ªå“ˆå¸Œè¡¨keyçš„é”®å€¼
HSET key field value   
# èŽ·å–å“ˆå¸Œè¡¨keyå¯¹åº”çš„fieldé”®å€¼
HGET key field

# åœ¨ä¸€ä¸ªå“ˆå¸Œè¡¨keyä¸­å­˜å‚¨å¤šä¸ªé”®å€¼å¯¹
HMSET key field value [field value...] 
# æ‰¹é‡èŽ·å–å“ˆå¸Œè¡¨keyä¸­å¤šä¸ªfieldé”®å€¼
HMGET key field [field ...]       
# åˆ é™¤å“ˆå¸Œè¡¨keyä¸­çš„fieldé”®å€¼
HDEL key field [field ...]    

# è¿”å›žå“ˆå¸Œè¡¨keyä¸­fieldçš„æ•°é‡
HLEN key       
# è¿”å›žå“ˆå¸Œè¡¨keyä¸­æ‰€æœ‰çš„é”®å€¼
HGETALL key 

# ä¸ºå“ˆå¸Œè¡¨keyä¸­fieldé”®çš„å€¼åŠ ä¸Šå¢žé‡n
HINCRBY key field n                         
```

### åº”ç”¨åœºæ™¯

#### ç¼“å­˜å¯¹è±¡

Hash ç±»åž‹çš„ï¼ˆkeyï¼Œfieldï¼Œvalueï¼‰çš„ç»“æž„ä¸Žå¯¹è±¡çš„ï¼ˆå¯¹è±¡ idï¼Œå±žæ€§ï¼Œå€¼ï¼‰çš„ç»“æž„ç›¸ä¼¼ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥å­˜å‚¨å¯¹è±¡ã€‚

æˆ‘ä»¬ä»¥ç”¨æˆ·ä¿¡æ¯ä¸ºä¾‹ï¼Œå®ƒåœ¨å…³ç³»åž‹æ•°æ®åº“ä¸­çš„ç»“æž„æ˜¯è¿™æ ·çš„ï¼š

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/æ•°æ®ç±»åž‹/ç”¨æˆ·ä¿¡æ¯.png)

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼Œå°†ç”¨æˆ·å¯¹è±¡çš„ä¿¡æ¯å­˜å‚¨åˆ° Hash ç±»åž‹ï¼š

```shell
# å­˜å‚¨ä¸€ä¸ªå“ˆå¸Œè¡¨uid:1çš„é”®å€¼
> HMSET uid:1 name Tom age 15
2
# å­˜å‚¨ä¸€ä¸ªå“ˆå¸Œè¡¨uid:2çš„é”®å€¼
> HMSET uid:2 name Jerry age 13
2
# èŽ·å–å“ˆå¸Œè¡¨ç”¨æˆ·idä¸º1ä¸­æ‰€æœ‰çš„é”®å€¼
> HGETALL uid:1
1) "name"
2) "Tom"
3) "age"
4) "15"
```

Redis Hash å­˜å‚¨å…¶ç»“æž„å¦‚ä¸‹å›¾ï¼š

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/æ•°æ®ç±»åž‹/hashå­˜å‚¨ç»“æž„.png)

åœ¨ä»‹ç» String ç±»åž‹çš„åº”ç”¨åœºæ™¯æ—¶æœ‰æ‰€ä»‹ç»ï¼ŒString + Json ä¹Ÿæ˜¯å­˜å‚¨å¯¹è±¡çš„ä¸€ç§æ–¹å¼ï¼Œé‚£ä¹ˆå­˜å‚¨å¯¹è±¡æ—¶ï¼Œåˆ°åº•ç”¨ String + json è¿˜æ˜¯ç”¨ Hash å‘¢ï¼Ÿ

ä¸€èˆ¬å¯¹è±¡ç”¨ String + Json å­˜å‚¨ï¼Œå¯¹è±¡ä¸­æŸäº›é¢‘ç¹å˜åŒ–çš„å±žæ€§å¯ä»¥è€ƒè™‘æŠ½å‡ºæ¥ç”¨ Hash ç±»åž‹å­˜å‚¨ã€‚

#### è´­ç‰©è½¦

ä»¥ç”¨æˆ· id ä¸º keyï¼Œå•†å“ id ä¸º fieldï¼Œå•†å“æ•°é‡ä¸º valueï¼Œæ°å¥½æž„æˆäº†è´­ç‰©è½¦çš„ 3 ä¸ªè¦ç´ ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/æ•°æ®ç±»åž‹/è´­ç‰©è½¦.png)

æ¶‰åŠçš„å‘½ä»¤å¦‚ä¸‹ï¼š

- æ·»åŠ å•†å“ï¼š`HSET  cart:{ç”¨æˆ·id}  {å•†å“id}  1`
- æ·»åŠ æ•°é‡ï¼š`HINCRBY  cart:{ç”¨æˆ·id}  {å•†å“id}  1`
- å•†å“æ€»æ•°ï¼š`HLEN  cart:{ç”¨æˆ·id}`
- åˆ é™¤å•†å“ï¼š`HDEL  cart:{ç”¨æˆ·id}  {å•†å“id}`
- èŽ·å–è´­ç‰©è½¦æ‰€æœ‰å•†å“ï¼š`HGETALL  cart:{ç”¨æˆ·id}`

å½“å‰ä»…ä»…æ˜¯å°†å•†å“ ID å­˜å‚¨åˆ°äº† Redis ä¸­ï¼Œåœ¨å›žæ˜¾å•†å“å…·ä½“ä¿¡æ¯çš„æ—¶å€™ï¼Œè¿˜éœ€è¦æ‹¿ç€å•†å“ id æŸ¥è¯¢ä¸€æ¬¡æ•°æ®åº“ï¼ŒèŽ·å–å®Œæ•´çš„å•†å“çš„ä¿¡æ¯ã€‚

## Set

### ä»‹ç»

Set ç±»åž‹æ˜¯ä¸€ä¸ªæ— åºå¹¶å”¯ä¸€çš„é”®å€¼é›†åˆï¼Œå®ƒçš„å­˜å‚¨é¡ºåºä¸ä¼šæŒ‰ç…§æ’å…¥çš„å…ˆåŽé¡ºåºè¿›è¡Œå­˜å‚¨ã€‚

ä¸€ä¸ªé›†åˆæœ€å¤šå¯ä»¥å­˜å‚¨ `2^32-1` ä¸ªå…ƒç´ ã€‚æ¦‚å¿µå’Œæ•°å­¦ä¸­ä¸ªçš„é›†åˆåŸºæœ¬ç±»ä¼¼ï¼Œå¯ä»¥äº¤é›†ï¼Œå¹¶é›†ï¼Œå·®é›†ç­‰ç­‰ï¼Œæ‰€ä»¥ Set ç±»åž‹é™¤äº†æ”¯æŒé›†åˆå†…çš„å¢žåˆ æ”¹æŸ¥ï¼ŒåŒæ—¶è¿˜æ”¯æŒå¤šä¸ªé›†åˆå–äº¤é›†ã€å¹¶é›†ã€å·®é›†ã€‚

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/æ•°æ®ç±»åž‹/set.png)

Set ç±»åž‹å’Œ List ç±»åž‹çš„åŒºåˆ«å¦‚ä¸‹ï¼š

- List å¯ä»¥å­˜å‚¨é‡å¤å…ƒç´ ï¼ŒSet åªèƒ½å­˜å‚¨éžé‡å¤å…ƒç´ ï¼›
- List æ˜¯æŒ‰ç…§å…ƒç´ çš„å…ˆåŽé¡ºåºå­˜å‚¨å…ƒç´ çš„ï¼Œè€Œ Set åˆ™æ˜¯æ— åºæ–¹å¼å­˜å‚¨å…ƒç´ çš„ã€‚

### å†…éƒ¨å®žçŽ°

Set ç±»åž‹çš„åº•å±‚æ•°æ®ç»“æž„æ˜¯ç”±**å“ˆå¸Œè¡¨æˆ–æ•´æ•°é›†åˆ**å®žçŽ°çš„ï¼š

- å¦‚æžœé›†åˆä¸­çš„å…ƒç´ éƒ½æ˜¯æ•´æ•°ä¸”å…ƒç´ ä¸ªæ•°å°äºŽ `512` ï¼ˆé»˜è®¤å€¼ï¼Œ`set-maxintset-entries`é…ç½®ï¼‰ä¸ªï¼ŒRedis ä¼šä½¿ç”¨**æ•´æ•°é›†åˆ**ä½œä¸º Set ç±»åž‹çš„åº•å±‚æ•°æ®ç»“æž„ï¼›
- å¦‚æžœé›†åˆä¸­çš„å…ƒç´ ä¸æ»¡è¶³ä¸Šé¢æ¡ä»¶ï¼Œåˆ™ Redis ä½¿ç”¨**å“ˆå¸Œè¡¨**ä½œä¸º Set ç±»åž‹çš„åº•å±‚æ•°æ®ç»“æž„ã€‚

### å¸¸ç”¨å‘½ä»¤

Set å¸¸ç”¨æ“ä½œï¼š

```shell
# å¾€é›†åˆkeyä¸­å­˜å…¥å…ƒç´ ï¼Œå…ƒç´ å­˜åœ¨åˆ™å¿½ç•¥ï¼Œè‹¥keyä¸å­˜åœ¨åˆ™æ–°å»º
SADD key member [member ...]
# ä»Žé›†åˆkeyä¸­åˆ é™¤å…ƒç´ 
SREM key member [member ...] 
# èŽ·å–é›†åˆkeyä¸­æ‰€æœ‰å…ƒç´ 
SMEMBERS key
# èŽ·å–é›†åˆkeyä¸­çš„å…ƒç´ ä¸ªæ•°
SCARD key

# åˆ¤æ–­memberå…ƒç´ æ˜¯å¦å­˜åœ¨äºŽé›†åˆkeyä¸­
SISMEMBER key member

# ä»Žé›†åˆkeyä¸­éšæœºé€‰å‡ºcountä¸ªå…ƒç´ ï¼Œå…ƒç´ ä¸ä»Žkeyä¸­åˆ é™¤
SRANDMEMBER key [count]
# ä»Žé›†åˆkeyä¸­éšæœºé€‰å‡ºcountä¸ªå…ƒç´ ï¼Œå…ƒç´ ä»Žkeyä¸­åˆ é™¤
SPOP key [count]
```

Set è¿ç®—æ“ä½œï¼š

```shell
# äº¤é›†è¿ç®—
SINTER key [key ...]
# å°†äº¤é›†ç»“æžœå­˜å…¥æ–°é›†åˆdestinationä¸­
SINTERSTORE destination key [key ...]

# å¹¶é›†è¿ç®—
SUNION key [key ...]
# å°†å¹¶é›†ç»“æžœå­˜å…¥æ–°é›†åˆdestinationä¸­
SUNIONSTORE destination key [key ...]

# å·®é›†è¿ç®—
SDIFF key [key ...]
# å°†å·®é›†ç»“æžœå­˜å…¥æ–°é›†åˆdestinationä¸­
SDIFFSTORE destination key [key ...]
```

### åº”ç”¨åœºæ™¯

é›†åˆçš„ä¸»è¦å‡ ä¸ªç‰¹æ€§ï¼Œæ— åºã€ä¸å¯é‡å¤ã€æ”¯æŒå¹¶äº¤å·®ç­‰æ“ä½œã€‚

å› æ­¤ Set ç±»åž‹æ¯”è¾ƒé€‚åˆç”¨æ¥æ•°æ®åŽ»é‡å’Œä¿éšœæ•°æ®çš„å”¯ä¸€æ€§ï¼Œè¿˜å¯ä»¥ç”¨æ¥ç»Ÿè®¡å¤šä¸ªé›†åˆçš„äº¤é›†ã€å·®é›†å’Œå¹¶é›†ç­‰ï¼Œå½“æˆ‘ä»¬å­˜å‚¨çš„æ•°æ®æ˜¯æ— åºå¹¶ä¸”éœ€è¦åŽ»é‡çš„æƒ…å†µä¸‹ï¼Œæ¯”è¾ƒé€‚åˆä½¿ç”¨é›†åˆç±»åž‹è¿›è¡Œå­˜å‚¨ã€‚

ä½†æ˜¯è¦æé†’ä½ ä¸€ä¸‹ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæ½œåœ¨çš„é£Žé™©ã€‚**Set çš„å·®é›†ã€å¹¶é›†å’Œäº¤é›†çš„è®¡ç®—å¤æ‚åº¦è¾ƒé«˜ï¼Œåœ¨æ•°æ®é‡è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼Œå¦‚æžœç›´æŽ¥æ‰§è¡Œè¿™äº›è®¡ç®—ï¼Œä¼šå¯¼è‡´ Redis å®žä¾‹é˜»å¡ž**ã€‚

åœ¨ä¸»ä»Žé›†ç¾¤ä¸­ï¼Œä¸ºäº†é¿å…ä¸»åº“å› ä¸º Set åšèšåˆè®¡ç®—ï¼ˆäº¤é›†ã€å·®é›†ã€å¹¶é›†ï¼‰æ—¶å¯¼è‡´ä¸»åº“è¢«é˜»å¡žï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä¸€ä¸ªä»Žåº“å®Œæˆèšåˆç»Ÿè®¡ï¼Œæˆ–è€…æŠŠæ•°æ®è¿”å›žç»™å®¢æˆ·ç«¯ï¼Œç”±å®¢æˆ·ç«¯æ¥å®Œæˆèšåˆç»Ÿè®¡ã€‚

#### ç‚¹èµž

Set ç±»åž‹å¯ä»¥ä¿è¯ä¸€ä¸ªç”¨æˆ·åªèƒ½ç‚¹ä¸€ä¸ªèµžï¼Œè¿™é‡Œä¸¾ä¾‹å­ä¸€ä¸ªåœºæ™¯ï¼Œkey æ˜¯æ–‡ç«  idï¼Œvalue æ˜¯ç”¨æˆ· idã€‚

`uid:1` ã€`uid:2`ã€`uid:3`   ä¸‰ä¸ªç”¨æˆ·åˆ†åˆ«å¯¹ article:1 æ–‡ç« ç‚¹èµžäº†ã€‚

```shell
# uid:1 ç”¨æˆ·å¯¹æ–‡ç«  article:1 ç‚¹èµž
> SADD article:1 uid:1
(integer) 1
# uid:2 ç”¨æˆ·å¯¹æ–‡ç«  article:1 ç‚¹èµž
> SADD article:1 uid:2
(integer) 1
# uid:3 ç”¨æˆ·å¯¹æ–‡ç«  article:1 ç‚¹èµž
> SADD article:1 uid:3
(integer) 1
```

`uid:1` å–æ¶ˆäº†å¯¹ article:1 æ–‡ç« ç‚¹èµžã€‚

```plain
> SREM article:1 uid:1
(integer) 1
```

èŽ·å–  article:1 æ–‡ç« æ‰€æœ‰ç‚¹èµžç”¨æˆ· :

```shell
> SMEMBERS article:1
1) "uid:3"
2) "uid:2"
```

èŽ·å– article:1 æ–‡ç« çš„ç‚¹èµžç”¨æˆ·æ•°é‡ï¼š

```shell
> SCARD article:1
(integer) 2
```

åˆ¤æ–­ç”¨æˆ· `uid:1` æ˜¯å¦å¯¹æ–‡ç«  article:1 ç‚¹èµžäº†ï¼š

```shell
> SISMEMBER article:1 uid:1
(integer) 0  # è¿”å›ž0è¯´æ˜Žæ²¡ç‚¹èµžï¼Œè¿”å›ž1åˆ™è¯´æ˜Žç‚¹èµžäº†
```

#### å…±åŒå…³æ³¨

Set ç±»åž‹æ”¯æŒäº¤é›†è¿ç®—ï¼Œæ‰€ä»¥å¯ä»¥ç”¨æ¥è®¡ç®—å…±åŒå…³æ³¨çš„å¥½å‹ã€å…¬ä¼—å·ç­‰ã€‚

key å¯ä»¥æ˜¯ç”¨æˆ· idï¼Œvalue åˆ™æ˜¯å·²å…³æ³¨çš„å…¬ä¼—å·çš„ idã€‚

`uid:1` ç”¨æˆ·å…³æ³¨å…¬ä¼—å· id ä¸º 5ã€6ã€7ã€8ã€9ï¼Œ`uid:2`  ç”¨æˆ·å…³æ³¨å…¬ä¼—å· id ä¸º 7ã€8ã€9ã€10ã€11ã€‚

```shell
# uid:1 ç”¨æˆ·å…³æ³¨å…¬ä¼—å· id ä¸º 5ã€6ã€7ã€8ã€9
> SADD uid:1 5 6 7 8 9
(integer) 5
# uid:2  ç”¨æˆ·å…³æ³¨å…¬ä¼—å· id ä¸º 7ã€8ã€9ã€10ã€11
> SADD uid:2 7 8 9 10 11
(integer) 5
```

`uid:1`  å’Œ `uid:2`  å…±åŒå…³æ³¨çš„å…¬ä¼—å·ï¼š

```shell
# èŽ·å–å…±åŒå…³æ³¨
> SINTER uid:1 uid:2
1) "7"
2) "8"
3) "9"
```

ç»™  `uid:2`   æŽ¨è `uid:1` å…³æ³¨çš„å…¬ä¼—å·ï¼š

```shell
> SDIFF uid:1 uid:2
1) "5"
2) "6"
```

éªŒè¯æŸä¸ªå…¬ä¼—å·æ˜¯å¦åŒæ—¶è¢«  `uid:1`   æˆ–  `uid:2`   å…³æ³¨ï¼š

```shell
> SISMEMBER uid:1 5
(integer) 1 # è¿”å›ž1ï¼Œè¯´æ˜Žå…³æ³¨äº†
> SISMEMBER uid:2 5
(integer) 0 # è¿”å›ž0ï¼Œè¯´æ˜Žæ²¡å…³æ³¨
```

#### æŠ½å¥–æ´»åŠ¨

å­˜å‚¨æŸæ´»åŠ¨ä¸­ä¸­å¥–çš„ç”¨æˆ·åï¼ŒSet ç±»åž‹å› ä¸ºæœ‰åŽ»é‡åŠŸèƒ½ï¼Œå¯ä»¥ä¿è¯åŒä¸€ä¸ªç”¨æˆ·ä¸ä¼šä¸­å¥–ä¸¤æ¬¡ã€‚

key ä¸ºæŠ½å¥–æ´»åŠ¨åï¼Œvalue ä¸ºå‘˜å·¥åç§°ï¼ŒæŠŠæ‰€æœ‰å‘˜å·¥åç§°æ”¾å…¥æŠ½å¥–ç®±ï¼š

```shell
>SADD lucky Tom Jerry John Sean Marry Lindy Sary Mark
(integer) 5
```

å¦‚æžœå…è®¸é‡å¤ä¸­å¥–ï¼Œå¯ä»¥ä½¿ç”¨ SRANDMEMBER å‘½ä»¤ã€‚

```shell
# æŠ½å– 1 ä¸ªä¸€ç­‰å¥–ï¼š
> SRANDMEMBER lucky 1
1) "Tom"
# æŠ½å– 2 ä¸ªäºŒç­‰å¥–ï¼š
> SRANDMEMBER lucky 2
1) "Mark"
2) "Jerry"
# æŠ½å– 3 ä¸ªä¸‰ç­‰å¥–ï¼š
> SRANDMEMBER lucky 3
1) "Sary"
2) "Tom"
3) "Jerry"
```

å¦‚æžœä¸å…è®¸é‡å¤ä¸­å¥–ï¼Œå¯ä»¥ä½¿ç”¨ SPOP å‘½ä»¤ã€‚

```shell
# æŠ½å–ä¸€ç­‰å¥–1ä¸ª
> SPOP lucky 1
1) "Sary"
# æŠ½å–äºŒç­‰å¥–2ä¸ª
> SPOP lucky 2
1) "Jerry"
2) "Mark"
# æŠ½å–ä¸‰ç­‰å¥–3ä¸ª
> SPOP lucky 3
1) "John"
2) "Sean"
3) "Lindy"
```

## Zset

### ä»‹ç»

Zset ç±»åž‹ï¼ˆæœ‰åºé›†åˆç±»åž‹ï¼‰ç›¸æ¯”äºŽ Set ç±»åž‹å¤šäº†ä¸€ä¸ªæŽ’åºå±žæ€§ scoreï¼ˆåˆ†å€¼ï¼‰ï¼Œå¯¹äºŽæœ‰åºé›†åˆ ZSet æ¥è¯´ï¼Œæ¯ä¸ªå­˜å‚¨å…ƒç´ ç›¸å½“äºŽæœ‰ä¸¤ä¸ªå€¼ç»„æˆçš„ï¼Œä¸€ä¸ªæ˜¯æœ‰åºç»“åˆçš„å…ƒç´ å€¼ï¼Œä¸€ä¸ªæ˜¯æŽ’åºå€¼ã€‚

æœ‰åºé›†åˆä¿ç•™äº†é›†åˆä¸èƒ½æœ‰é‡å¤æˆå‘˜çš„ç‰¹æ€§ï¼ˆåˆ†å€¼å¯ä»¥é‡å¤ï¼‰ï¼Œä½†ä¸åŒçš„æ˜¯ï¼Œæœ‰åºé›†åˆä¸­çš„å…ƒç´ å¯ä»¥æŽ’åºã€‚

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/æ•°æ®ç±»åž‹/zset.png)

### å†…éƒ¨å®žçŽ°

Zset ç±»åž‹çš„åº•å±‚æ•°æ®ç»“æž„æ˜¯ç”±**åŽ‹ç¼©åˆ—è¡¨æˆ–è·³è¡¨**å®žçŽ°çš„ï¼š

- å¦‚æžœæœ‰åºé›†åˆçš„å…ƒç´ ä¸ªæ•°å°äºŽ `128` ä¸ªï¼Œå¹¶ä¸”æ¯ä¸ªå…ƒç´ çš„å€¼å°äºŽ `64` å­—èŠ‚æ—¶ï¼ŒRedis ä¼šä½¿ç”¨**åŽ‹ç¼©åˆ—è¡¨**ä½œä¸º Zset ç±»åž‹çš„åº•å±‚æ•°æ®ç»“æž„ï¼›
- å¦‚æžœæœ‰åºé›†åˆçš„å…ƒç´ ä¸æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶ï¼ŒRedis ä¼šä½¿ç”¨**è·³è¡¨**ä½œä¸º Zset ç±»åž‹çš„åº•å±‚æ•°æ®ç»“æž„ï¼›

**åœ¨ Redis 7.0 ä¸­ï¼ŒåŽ‹ç¼©åˆ—è¡¨æ•°æ®ç»“æž„å·²ç»åºŸå¼ƒäº†ï¼Œäº¤ç”± listpack æ•°æ®ç»“æž„æ¥å®žçŽ°äº†ã€‚**

### å¸¸ç”¨å‘½ä»¤

Zset å¸¸ç”¨æ“ä½œï¼š

```shell
# å¾€æœ‰åºé›†åˆkeyä¸­åŠ å…¥å¸¦åˆ†å€¼å…ƒç´ 
ZADD key score member [[score member]...]   
# å¾€æœ‰åºé›†åˆkeyä¸­åˆ é™¤å…ƒç´ 
ZREM key member [member...]                 
# è¿”å›žæœ‰åºé›†åˆkeyä¸­å…ƒç´ memberçš„åˆ†å€¼
ZSCORE key member
# è¿”å›žæœ‰åºé›†åˆkeyä¸­å…ƒç´ ä¸ªæ•°
ZCARD key 

# ä¸ºæœ‰åºé›†åˆkeyä¸­å…ƒç´ memberçš„åˆ†å€¼åŠ ä¸Šincrement
ZINCRBY key increment member 

# æ­£åºèŽ·å–æœ‰åºé›†åˆkeyä»Žstartä¸‹æ ‡åˆ°stopä¸‹æ ‡çš„å…ƒç´ 
ZRANGE key start stop [WITHSCORES]
# å€’åºèŽ·å–æœ‰åºé›†åˆkeyä»Žstartä¸‹æ ‡åˆ°stopä¸‹æ ‡çš„å…ƒç´ 
ZREVRANGE key start stop [WITHSCORES]

# è¿”å›žæœ‰åºé›†åˆä¸­æŒ‡å®šåˆ†æ•°åŒºé—´å†…çš„æˆå‘˜ï¼Œåˆ†æ•°ç”±ä½Žåˆ°é«˜æŽ’åºã€‚
ZRANGEBYSCORE key min max [WITHSCORES] [LIMIT offset count]

# è¿”å›žæŒ‡å®šæˆå‘˜åŒºé—´å†…çš„æˆå‘˜ï¼ŒæŒ‰å­—å…¸æ­£åºæŽ’åˆ—, åˆ†æ•°å¿…é¡»ç›¸åŒã€‚
ZRANGEBYLEX key min max [LIMIT offset count]
# è¿”å›žæŒ‡å®šæˆå‘˜åŒºé—´å†…çš„æˆå‘˜ï¼ŒæŒ‰å­—å…¸å€’åºæŽ’åˆ—, åˆ†æ•°å¿…é¡»ç›¸åŒ
ZREVRANGEBYLEX key max min [LIMIT offset count]
```

Zset è¿ç®—æ“ä½œï¼ˆç›¸æ¯”äºŽ Set ç±»åž‹ï¼ŒZSet ç±»åž‹æ²¡æœ‰æ”¯æŒå·®é›†è¿ç®—ï¼‰ï¼š

```shell
# å¹¶é›†è®¡ç®—(ç›¸åŒå…ƒç´ åˆ†å€¼ç›¸åŠ )ï¼Œnumberkeysä¸€å…±å¤šå°‘ä¸ªkeyï¼ŒWEIGHTSæ¯ä¸ªkeyå¯¹åº”çš„åˆ†å€¼ä¹˜ç§¯
ZUNIONSTORE destkey numberkeys key [key...] 
# äº¤é›†è®¡ç®—(ç›¸åŒå…ƒç´ åˆ†å€¼ç›¸åŠ )ï¼Œnumberkeysä¸€å…±å¤šå°‘ä¸ªkeyï¼ŒWEIGHTSæ¯ä¸ªkeyå¯¹åº”çš„åˆ†å€¼ä¹˜ç§¯
ZINTERSTORE destkey numberkeys key [key...]
```

### åº”ç”¨åœºæ™¯

Zset ç±»åž‹ï¼ˆSorted Setï¼Œæœ‰åºé›†åˆï¼‰å¯ä»¥æ ¹æ®å…ƒç´ çš„æƒé‡æ¥æŽ’åºï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±æ¥å†³å®šæ¯ä¸ªå…ƒç´ çš„æƒé‡å€¼ã€‚æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®å…ƒç´ æ’å…¥ Sorted Set çš„æ—¶é—´ç¡®å®šæƒé‡å€¼ï¼Œå…ˆæ’å…¥çš„å…ƒç´ æƒé‡å°ï¼ŒåŽæ’å…¥çš„å…ƒç´ æƒé‡å¤§ã€‚

åœ¨é¢å¯¹éœ€è¦å±•ç¤ºæœ€æ–°åˆ—è¡¨ã€æŽ’è¡Œæ¦œç­‰åœºæ™¯æ—¶ï¼Œå¦‚æžœæ•°æ®æ›´æ–°é¢‘ç¹æˆ–è€…éœ€è¦åˆ†é¡µæ˜¾ç¤ºï¼Œå¯ä»¥ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨ Sorted Setã€‚

#### æŽ’è¡Œæ¦œ

æœ‰åºé›†åˆæ¯”è¾ƒå…¸åž‹çš„ä½¿ç”¨åœºæ™¯å°±æ˜¯æŽ’è¡Œæ¦œã€‚ä¾‹å¦‚å­¦ç”Ÿæˆç»©çš„æŽ’åæ¦œã€æ¸¸æˆç§¯åˆ†æŽ’è¡Œæ¦œã€è§†é¢‘æ’­æ”¾æŽ’åã€ç”µå•†ç³»ç»Ÿä¸­å•†å“çš„é”€é‡æŽ’åç­‰ã€‚

æˆ‘ä»¬ä»¥åšæ–‡ç‚¹èµžæŽ’åä¸ºä¾‹ï¼Œå°æž—å‘è¡¨äº†äº”ç¯‡åšæ–‡ï¼Œåˆ†åˆ«èŽ·å¾—èµžä¸º 200ã€40ã€100ã€50ã€150ã€‚

```shell
# arcticle:1 æ–‡ç« èŽ·å¾—äº†200ä¸ªèµž
> ZADD user:xiaolin:ranking 200 arcticle:1
(integer) 1
# arcticle:2 æ–‡ç« èŽ·å¾—äº†40ä¸ªèµž
> ZADD user:xiaolin:ranking 40 arcticle:2
(integer) 1
# arcticle:3 æ–‡ç« èŽ·å¾—äº†100ä¸ªèµž
> ZADD user:xiaolin:ranking 100 arcticle:3
(integer) 1
# arcticle:4 æ–‡ç« èŽ·å¾—äº†50ä¸ªèµž
> ZADD user:xiaolin:ranking 50 arcticle:4
(integer) 1
# arcticle:5 æ–‡ç« èŽ·å¾—äº†150ä¸ªèµž
> ZADD user:xiaolin:ranking 150 arcticle:5
(integer) 1
```

æ–‡ç«  arcticle:4 æ–°å¢žä¸€ä¸ªèµžï¼Œå¯ä»¥ä½¿ç”¨ ZINCRBY å‘½ä»¤ï¼ˆä¸ºæœ‰åºé›†åˆ key ä¸­å…ƒç´  member çš„åˆ†å€¼åŠ ä¸Š incrementï¼‰ï¼š

```shell
> ZINCRBY user:xiaolin:ranking 1 arcticle:4
"51"
```

æŸ¥çœ‹æŸç¯‡æ–‡ç« çš„èµžæ•°ï¼Œå¯ä»¥ä½¿ç”¨ ZSCORE å‘½ä»¤ï¼ˆè¿”å›žæœ‰åºé›†åˆ key ä¸­å…ƒç´ ä¸ªæ•°ï¼‰ï¼š

```shell
> ZSCORE user:xiaolin:ranking arcticle:4
"50"
```

èŽ·å–å°æž—æ–‡ç« èµžæ•°æœ€å¤šçš„ 3 ç¯‡æ–‡ç« ï¼Œå¯ä»¥ä½¿ç”¨ ZREVRANGE å‘½ä»¤ï¼ˆå€’åºèŽ·å–æœ‰åºé›†åˆ key ä»Ž start ä¸‹æ ‡åˆ° stop ä¸‹æ ‡çš„å…ƒç´ ï¼‰ï¼š

```shell
# WITHSCORES è¡¨ç¤ºæŠŠ score ä¹Ÿæ˜¾ç¤ºå‡ºæ¥
> ZREVRANGE user:xiaolin:ranking 0 2 WITHSCORES
1) "arcticle:1"
2) "200"
3) "arcticle:5"
4) "150"
5) "arcticle:3"
6) "100"
```

èŽ·å–å°æž— 100 èµžåˆ° 200 èµžçš„æ–‡ç« ï¼Œå¯ä»¥ä½¿ç”¨ ZRANGEBYSCORE å‘½ä»¤ï¼ˆè¿”å›žæœ‰åºé›†åˆä¸­æŒ‡å®šåˆ†æ•°åŒºé—´å†…çš„æˆå‘˜ï¼Œåˆ†æ•°ç”±ä½Žåˆ°é«˜æŽ’åºï¼‰ï¼š

```shell
> ZRANGEBYSCORE user:xiaolin:ranking 100 200 WITHSCORES
1) "arcticle:3"
2) "100"
3) "arcticle:5"
4) "150"
5) "arcticle:1"
6) "200"
```

#### ç”µè¯ã€å§“åæŽ’åº

ä½¿ç”¨æœ‰åºé›†åˆçš„ `ZRANGEBYLEX` æˆ– `ZREVRANGEBYLEX` å¯ä»¥å¸®åŠ©æˆ‘ä»¬å®žçŽ°ç”µè¯å·ç æˆ–å§“åçš„æŽ’åºï¼Œæˆ‘ä»¬ä»¥ `ZRANGEBYLEX` ï¼ˆè¿”å›žæŒ‡å®šæˆå‘˜åŒºé—´å†…çš„æˆå‘˜ï¼ŒæŒ‰ key æ­£åºæŽ’åˆ—ï¼Œåˆ†æ•°å¿…é¡»ç›¸åŒï¼‰ä¸ºä¾‹ã€‚

**æ³¨æ„ï¼šä¸è¦åœ¨åˆ†æ•°ä¸ä¸€è‡´çš„ SortSet é›†åˆä¸­åŽ»ä½¿ç”¨ ZRANGEBYLEX å’Œ ZREVRANGEBYLEX æŒ‡ä»¤ï¼Œå› ä¸ºèŽ·å–çš„ç»“æžœä¼šä¸å‡†ç¡®ã€‚**

*1ã€ç”µè¯æŽ’åº*

æˆ‘ä»¬å¯ä»¥å°†ç”µè¯å·ç å­˜å‚¨åˆ° SortSet ä¸­ï¼Œç„¶åŽæ ¹æ®éœ€è¦æ¥èŽ·å–å·æ®µï¼š

```shell
> ZADD phone 0 13100111100 0 13110114300 0 13132110901 
(integer) 3
> ZADD phone 0 13200111100 0 13210414300 0 13252110901 
(integer) 3
> ZADD phone 0 13300111100 0 13310414300 0 13352110901 
(integer) 3
```

èŽ·å–æ‰€æœ‰å·ç ï¼š

```shell
> ZRANGEBYLEX phone - +
1) "13100111100"
2) "13110114300"
3) "13132110901"
4) "13200111100"
5) "13210414300"
6) "13252110901"
7) "13300111100"
8) "13310414300"
9) "13352110901"
```

èŽ·å– 132 å·æ®µçš„å·ç ï¼š

```shell
> ZRANGEBYLEX phone [132 (133
1) "13200111100"
2) "13210414300"
3) "13252110901"
```

èŽ·å– 132ã€133 å·æ®µçš„å·ç ï¼š

```shell
> ZRANGEBYLEX phone [132 (134
1) "13200111100"
2) "13210414300"
3) "13252110901"
4) "13300111100"
5) "13310414300"
6) "13352110901"
```

*2ã€å§“åæŽ’åº*

```shell
> zadd names 0 Toumas 0 Jake 0 Bluetuo 0 Gaodeng 0 Aimini 0 Aidehua 
(integer) 6
```

èŽ·å–æ‰€æœ‰äººçš„åå­—ï¼š

```shell
> ZRANGEBYLEX names - +
1) "Aidehua"
2) "Aimini"
3) "Bluetuo"
4) "Gaodeng"
5) "Jake"
6) "Toumas"
```

èŽ·å–åå­—ä¸­å¤§å†™å­—æ¯ A å¼€å¤´çš„æ‰€æœ‰äººï¼š

```shell
> ZRANGEBYLEX names [A (B
1) "Aidehua"
2) "Aimini"
```

èŽ·å–åå­—ä¸­å¤§å†™å­—æ¯ C åˆ° Z çš„æ‰€æœ‰äººï¼š

```shell
> ZRANGEBYLEX names [C [Z
1) "Gaodeng"
2) "Jake"
3) "Toumas"
```

## BitMap

### ä»‹ç»

Bitmapï¼Œå³ä½å›¾ï¼Œæ˜¯ä¸€ä¸²è¿žç»­çš„äºŒè¿›åˆ¶æ•°ç»„ï¼ˆ0 å’Œ 1ï¼‰ï¼Œå¯ä»¥é€šè¿‡åç§»é‡ï¼ˆoffsetï¼‰å®šä½å…ƒç´ ã€‚BitMap é€šè¿‡æœ€å°çš„å•ä½ bit æ¥è¿›è¡Œ`0|1`çš„è®¾ç½®ï¼Œè¡¨ç¤ºæŸä¸ªå…ƒç´ çš„å€¼æˆ–è€…çŠ¶æ€ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚

ç”±äºŽ bit æ˜¯è®¡ç®—æœºä¸­æœ€å°çš„å•ä½ï¼Œä½¿ç”¨å®ƒè¿›è¡Œå‚¨å­˜å°†éžå¸¸èŠ‚çœç©ºé—´ï¼Œç‰¹åˆ«é€‚åˆä¸€äº›æ•°æ®é‡å¤§ä¸”ä½¿ç”¨**äºŒå€¼ç»Ÿè®¡çš„åœºæ™¯**ã€‚

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/æ•°æ®ç±»åž‹/bitmap.png)

### å†…éƒ¨å®žçŽ°

Bitmap æœ¬èº«æ˜¯ç”¨ String ç±»åž‹ä½œä¸ºåº•å±‚æ•°æ®ç»“æž„å®žçŽ°çš„ä¸€ç§ç»Ÿè®¡äºŒå€¼çŠ¶æ€çš„æ•°æ®ç±»åž‹ã€‚

String ç±»åž‹æ˜¯ä¼šä¿å­˜ä¸ºäºŒè¿›åˆ¶çš„å­—èŠ‚æ•°ç»„ï¼Œæ‰€ä»¥ï¼ŒRedis å°±æŠŠå­—èŠ‚æ•°ç»„çš„æ¯ä¸ª bit ä½åˆ©ç”¨èµ·æ¥ï¼Œç”¨æ¥è¡¨ç¤ºä¸€ä¸ªå…ƒç´ çš„äºŒå€¼çŠ¶æ€ï¼Œä½ å¯ä»¥æŠŠ Bitmap çœ‹ä½œæ˜¯ä¸€ä¸ª bit æ•°ç»„ã€‚

### å¸¸ç”¨å‘½ä»¤

bitmap åŸºæœ¬æ“ä½œï¼š

```shell
# è®¾ç½®å€¼ï¼Œå…¶ä¸­valueåªèƒ½æ˜¯ 0 å’Œ 1
SETBIT key offset value

# èŽ·å–å€¼
GETBIT key offset

# èŽ·å–æŒ‡å®šèŒƒå›´å†…å€¼ä¸º 1 çš„ä¸ªæ•°
# start å’Œ end ä»¥å­—èŠ‚ä¸ºå•ä½
BITCOUNT key start end
```

bitmap è¿ç®—æ“ä½œï¼š

```shell
# BitMapé—´çš„è¿ç®—
# operations ä½ç§»æ“ä½œç¬¦ï¼Œæžšä¸¾å€¼
  AND ä¸Žè¿ç®— &
  OR æˆ–è¿ç®— |
  XOR å¼‚æˆ– ^
  NOT å–å ~
# result è®¡ç®—çš„ç»“æžœï¼Œä¼šå­˜å‚¨åœ¨è¯¥keyä¸­
# key1 â€¦ keyn å‚ä¸Žè¿ç®—çš„keyï¼Œå¯ä»¥æœ‰å¤šä¸ªï¼Œç©ºæ ¼åˆ†å‰²ï¼Œnotè¿ç®—åªèƒ½ä¸€ä¸ªkey
# å½“ BITOP å¤„ç†ä¸åŒé•¿åº¦çš„å­—ç¬¦ä¸²æ—¶ï¼Œè¾ƒçŸ­çš„é‚£ä¸ªå­—ç¬¦ä¸²æ‰€ç¼ºå°‘çš„éƒ¨åˆ†ä¼šè¢«çœ‹ä½œ 0ã€‚è¿”å›žå€¼æ˜¯ä¿å­˜åˆ° destkey çš„å­—ç¬¦ä¸²çš„é•¿åº¦ï¼ˆä»¥å­—èŠ‚byteä¸ºå•ä½ï¼‰ï¼Œå’Œè¾“å…¥ key ä¸­æœ€é•¿çš„å­—ç¬¦ä¸²é•¿åº¦ç›¸ç­‰ã€‚
BITOP [operations] [result] [key1] [keynâ€¦]

# è¿”å›žæŒ‡å®škeyä¸­ç¬¬ä¸€æ¬¡å‡ºçŽ°æŒ‡å®švalue(0/1)çš„ä½ç½®
BITPOS [key] [value]
```

### åº”ç”¨åœºæ™¯

Bitmap ç±»åž‹éžå¸¸é€‚åˆäºŒå€¼çŠ¶æ€ç»Ÿè®¡çš„åœºæ™¯ï¼Œè¿™é‡Œçš„äºŒå€¼çŠ¶æ€å°±æ˜¯æŒ‡é›†åˆå…ƒç´ çš„å–å€¼å°±åªæœ‰ 0 å’Œ 1 ä¸¤ç§ï¼Œåœ¨è®°å½•æµ·é‡æ•°æ®æ—¶ï¼ŒBitmap èƒ½å¤Ÿæœ‰æ•ˆåœ°èŠ‚çœå†…å­˜ç©ºé—´ã€‚

#### ç­¾åˆ°ç»Ÿè®¡

åœ¨ç­¾åˆ°æ‰“å¡çš„åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬åªç”¨è®°å½•ç­¾åˆ°ï¼ˆ1ï¼‰æˆ–æœªç­¾åˆ°ï¼ˆ0ï¼‰ï¼Œæ‰€ä»¥å®ƒå°±æ˜¯éžå¸¸å…¸åž‹çš„äºŒå€¼çŠ¶æ€ã€‚

ç­¾åˆ°ç»Ÿè®¡æ—¶ï¼Œæ¯ä¸ªç”¨æˆ·ä¸€å¤©çš„ç­¾åˆ°ç”¨ 1 ä¸ª bit ä½å°±èƒ½è¡¨ç¤ºï¼Œä¸€ä¸ªæœˆï¼ˆå‡è®¾æ˜¯ 31 å¤©ï¼‰çš„ç­¾åˆ°æƒ…å†µç”¨ 31 ä¸ª bit ä½å°±å¯ä»¥ï¼Œè€Œä¸€å¹´çš„ç­¾åˆ°ä¹Ÿåªéœ€è¦ç”¨ 365 ä¸ª bit ä½ï¼Œæ ¹æœ¬ä¸ç”¨å¤ªå¤æ‚çš„é›†åˆç±»åž‹ã€‚

å‡è®¾æˆ‘ä»¬è¦ç»Ÿè®¡ ID 100 çš„ç”¨æˆ·åœ¨ 2022 å¹´ 6 æœˆä»½çš„ç­¾åˆ°æƒ…å†µï¼Œå°±å¯ä»¥æŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤è¿›è¡Œæ“ä½œã€‚

ç¬¬ä¸€æ­¥ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œè®°å½•è¯¥ç”¨æˆ· 6 æœˆ 3 å·å·²ç­¾åˆ°ã€‚

```shell
SETBIT uid:sign:100:202206 2 1
```

ç¬¬äºŒæ­¥ï¼Œæ£€æŸ¥è¯¥ç”¨æˆ· 6 æœˆ 3 æ—¥æ˜¯å¦ç­¾åˆ°ã€‚

```shell
GETBIT uid:sign:100:202206 2 
```

ç¬¬ä¸‰æ­¥ï¼Œç»Ÿè®¡è¯¥ç”¨æˆ·åœ¨ 6 æœˆä»½çš„ç­¾åˆ°æ¬¡æ•°ã€‚

```shell
BITCOUNT uid:sign:100:202206
```

è¿™æ ·ï¼Œæˆ‘ä»¬å°±çŸ¥é“è¯¥ç”¨æˆ·åœ¨ 6 æœˆä»½çš„ç­¾åˆ°æƒ…å†µäº†ã€‚

> å¦‚ä½•ç»Ÿè®¡è¿™ä¸ªæœˆé¦–æ¬¡æ‰“å¡æ—¶é—´å‘¢ï¼Ÿ

Redis æä¾›äº† `BITPOS key bitValue [start] [end]`æŒ‡ä»¤ï¼Œè¿”å›žæ•°æ®è¡¨ç¤º Bitmap ä¸­ç¬¬ä¸€ä¸ªå€¼ä¸º `bitValue` çš„ offset ä½ç½®ã€‚

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå‘½ä»¤å°†æ£€æµ‹æ•´ä¸ªä½å›¾ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡å¯é€‰çš„ `start` å‚æ•°å’Œ `end` å‚æ•°æŒ‡å®šè¦æ£€æµ‹çš„èŒƒå›´ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡æ‰§è¡Œè¿™æ¡å‘½ä»¤æ¥èŽ·å– userID = 100 åœ¨ 2022 å¹´ 6 æœˆä»½**é¦–æ¬¡æ‰“å¡**æ—¥æœŸï¼š

```apache
BITPOS uid:sign:100:202206 1
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå› ä¸º offset ä»Ž 0 å¼€å§‹çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†è¿”å›žçš„ value + 1ã€‚

#### åˆ¤æ–­ç”¨æˆ·ç™»å½•æ€

Bitmap æä¾›äº† `GETBITã€SETBIT` æ“ä½œï¼Œé€šè¿‡ä¸€ä¸ªåç§»å€¼ offset å¯¹ bit æ•°ç»„çš„ offset ä½ç½®çš„ bit ä½è¿›è¡Œè¯»å†™æ“ä½œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ offset ä»Ž 0 å¼€å§‹ã€‚

åªéœ€è¦ä¸€ä¸ª key = login_status è¡¨ç¤ºå­˜å‚¨ç”¨æˆ·ç™»å½•çŠ¶æ€é›†åˆæ•°æ®ï¼Œå°†ç”¨æˆ· ID ä½œä¸º offsetï¼Œåœ¨çº¿å°±è®¾ç½®ä¸º 1ï¼Œä¸‹çº¿è®¾ç½® 0ã€‚é€šè¿‡ `GETBIT`åˆ¤æ–­å¯¹åº”çš„ç”¨æˆ·æ˜¯å¦åœ¨çº¿ã€‚50000 ä¸‡ ç”¨æˆ·åªéœ€è¦ 6 MB çš„ç©ºé—´ã€‚

å‡å¦‚æˆ‘ä»¬è¦åˆ¤æ–­ ID = 10086 çš„ç”¨æˆ·çš„ç™»å½•æƒ…å†µï¼š

ç¬¬ä¸€æ­¥ï¼Œæ‰§è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼Œè¡¨ç¤ºç”¨æˆ·å·²ç™»å½•ã€‚

```shell
SETBIT login_status 10086 1
```

ç¬¬äºŒæ­¥ï¼Œæ£€æŸ¥è¯¥ç”¨æˆ·æ˜¯å¦ç™»å½•ï¼Œè¿”å›žå€¼ 1 è¡¨ç¤ºå·²ç™»å½•ã€‚

```apache
GETBIT login_status 10086
```

ç¬¬ä¸‰æ­¥ï¼Œç™»å‡ºï¼Œå°† offset å¯¹åº”çš„ value è®¾ç½®æˆ 0ã€‚

```shell
SETBIT login_status 10086 0
```

#### è¿žç»­ç­¾åˆ°ç”¨æˆ·æ€»æ•°

å¦‚ä½•ç»Ÿè®¡å‡ºè¿™è¿žç»­ 7 å¤©è¿žç»­æ‰“å¡ç”¨æˆ·æ€»æ•°å‘¢ï¼Ÿ

æˆ‘ä»¬æŠŠæ¯å¤©çš„æ—¥æœŸä½œä¸º Bitmap çš„ keyï¼ŒuserId ä½œä¸º offsetï¼Œè‹¥æ˜¯æ‰“å¡åˆ™å°† offset ä½ç½®çš„ bit è®¾ç½®æˆ 1ã€‚

key å¯¹åº”çš„é›†åˆçš„æ¯ä¸ª bit ä½çš„æ•°æ®åˆ™æ˜¯ä¸€ä¸ªç”¨æˆ·åœ¨è¯¥æ—¥æœŸçš„æ‰“å¡è®°å½•ã€‚

ä¸€å…±æœ‰ 7 ä¸ªè¿™æ ·çš„ Bitmapï¼Œå¦‚æžœæˆ‘ä»¬èƒ½å¯¹è¿™ 7 ä¸ª Bitmap çš„å¯¹åº”çš„ bit ä½åš ã€Žä¸Žã€è¿ç®—ã€‚åŒæ ·çš„ UserID offset éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå½“ä¸€ä¸ª userID åœ¨ 7 ä¸ª Bitmap å¯¹åº”å¯¹åº”çš„ offset ä½ç½®çš„ bit = 1 å°±è¯´æ˜Žè¯¥ç”¨æˆ· 7 å¤©è¿žç»­æ‰“å¡ã€‚

ç»“æžœä¿å­˜åˆ°ä¸€ä¸ªæ–° Bitmap ä¸­ï¼Œæˆ‘ä»¬å†é€šè¿‡ `BITCOUNT` ç»Ÿè®¡ bit = 1 çš„ä¸ªæ•°ä¾¿å¾—åˆ°äº†è¿žç»­æ‰“å¡ 7 å¤©çš„ç”¨æˆ·æ€»æ•°äº†ã€‚

Redis æä¾›äº† `BITOP operation destkey key [key ...]`è¿™ä¸ªæŒ‡ä»¤ç”¨äºŽå¯¹ä¸€ä¸ªæˆ–è€…å¤šä¸ª key çš„ Bitmap è¿›è¡Œä½å…ƒæ“ä½œã€‚

- `operation` å¯ä»¥æ˜¯ `and`ã€`OR`ã€`NOT`ã€`XOR`ã€‚å½“ BITOP å¤„ç†ä¸åŒé•¿åº¦çš„å­—ç¬¦ä¸²æ—¶ï¼Œè¾ƒçŸ­çš„é‚£ä¸ªå­—ç¬¦ä¸²æ‰€ç¼ºå°‘çš„éƒ¨åˆ†ä¼šè¢«çœ‹ä½œ `0` ã€‚ç©ºçš„ `key` ä¹Ÿè¢«çœ‹ä½œæ˜¯åŒ…å« `0` çš„å­—ç¬¦ä¸²åºåˆ—ã€‚

å‡è®¾è¦ç»Ÿè®¡ 3 å¤©è¿žç»­æ‰“å¡çš„ç”¨æˆ·æ•°ï¼Œåˆ™æ˜¯å°†ä¸‰ä¸ª bitmap è¿›è¡Œ AND æ“ä½œï¼Œå¹¶å°†ç»“æžœä¿å­˜åˆ° destmap ä¸­ï¼ŒæŽ¥ç€å¯¹ destmap æ‰§è¡Œ BITCOUNT ç»Ÿè®¡ï¼Œå¦‚ä¸‹å‘½ä»¤ï¼š

```shell
# ä¸Žæ“ä½œ
BITOP AND destmap bitmap:01 bitmap:02 bitmap:03
# ç»Ÿè®¡ bit ä½ =  1 çš„ä¸ªæ•°
BITCOUNT destmap
```

å³ä½¿ä¸€å¤©äº§ç”Ÿä¸€ä¸ªäº¿çš„æ•°æ®ï¼ŒBitmap å ç”¨çš„å†…å­˜ä¹Ÿä¸å¤§ï¼Œå¤§çº¦å  12 MB çš„å†…å­˜ï¼ˆ10^8/8/1024/1024ï¼‰ï¼Œ7 å¤©çš„ Bitmap çš„å†…å­˜å¼€é”€çº¦ä¸º 84 MBã€‚åŒæ—¶æˆ‘ä»¬æœ€å¥½ç»™ Bitmap è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè®© Redis åˆ é™¤è¿‡æœŸçš„æ‰“å¡æ•°æ®ï¼ŒèŠ‚çœå†…å­˜ã€‚

## HyperLogLog

### ä»‹ç»

Redis HyperLogLog æ˜¯ Redis 2.8.9 ç‰ˆæœ¬æ–°å¢žçš„æ•°æ®ç±»åž‹ï¼Œæ˜¯ä¸€ç§ç”¨äºŽã€Œç»Ÿè®¡åŸºæ•°ã€çš„æ•°æ®é›†åˆç±»åž‹ï¼ŒåŸºæ•°ç»Ÿè®¡å°±æ˜¯æŒ‡ç»Ÿè®¡ä¸€ä¸ªé›†åˆä¸­ä¸é‡å¤çš„å…ƒç´ ä¸ªæ•°ã€‚ä½†è¦æ³¨æ„ï¼ŒHyperLogLog ç»Ÿè®¡è§„åˆ™æ˜¯åŸºäºŽæ¦‚çŽ‡å®Œæˆçš„ï¼Œä¸æ˜¯éžå¸¸å‡†ç¡®ï¼Œæ ‡å‡†è¯¯ç®—çŽ‡æ˜¯ 0.81%ã€‚

æ‰€ä»¥ï¼Œç®€å•æ¥è¯´ HyperLogLog **æä¾›ä¸ç²¾ç¡®çš„åŽ»é‡è®¡æ•°**ã€‚

HyperLogLog çš„ä¼˜ç‚¹æ˜¯ï¼Œåœ¨è¾“å…¥å…ƒç´ çš„æ•°é‡æˆ–è€…ä½“ç§¯éžå¸¸éžå¸¸å¤§æ—¶ï¼Œè®¡ç®—åŸºæ•°æ‰€éœ€çš„å†…å­˜ç©ºé—´æ€»æ˜¯å›ºå®šçš„ã€å¹¶ä¸”æ˜¯å¾ˆå°çš„ã€‚

åœ¨ Redis é‡Œé¢ï¼Œ**æ¯ä¸ª HyperLogLog é”®åªéœ€è¦èŠ±è´¹ 12 KB å†…å­˜ï¼Œå°±å¯ä»¥è®¡ç®—æŽ¥è¿‘ `2^64` ä¸ªä¸åŒå…ƒç´ çš„åŸºæ•°**ï¼Œå’Œå…ƒç´ è¶Šå¤šå°±è¶Šè€—è´¹å†…å­˜çš„ Set å’Œ Hash ç±»åž‹ç›¸æ¯”ï¼ŒHyperLogLog å°±éžå¸¸èŠ‚çœç©ºé—´ã€‚

è¿™ä»€ä¹ˆæ¦‚å¿µï¼Ÿä¸¾ä¸ªä¾‹å­ç»™å¤§å®¶å¯¹æ¯”ä¸€ä¸‹ã€‚

ç”¨ Java è¯­è¨€æ¥è¯´ï¼Œä¸€èˆ¬ long ç±»åž‹å ç”¨ 8 å­—èŠ‚ï¼Œè€Œ 1 å­—èŠ‚æœ‰ 8 ä½ï¼Œå³ï¼š1 byte = 8 bitï¼Œå³ long æ•°æ®ç±»åž‹æœ€å¤§å¯ä»¥è¡¨ç¤ºçš„æ•°æ˜¯ï¼š`2^63-1`ã€‚å¯¹åº”ä¸Šé¢çš„`2^64`ä¸ªæ•°ï¼Œå‡è®¾æ­¤æ—¶æœ‰`2^63-1`è¿™ä¹ˆå¤šä¸ªæ•°ï¼Œä»Ž `0 ~ 2^63-1`ï¼ŒæŒ‰ç…§`long`ä»¥åŠ`1k = 1024 å­—èŠ‚`çš„è§„åˆ™æ¥è®¡ç®—å†…å­˜æ€»æ•°ï¼Œå°±æ˜¯ï¼š`((2^63-1) * 8/1024)K`ï¼Œè¿™æ˜¯å¾ˆåºžå¤§çš„ä¸€ä¸ªæ•°ï¼Œå­˜å‚¨ç©ºé—´è¿œè¿œè¶…è¿‡`12K`ï¼Œè€Œ `HyperLogLog` å´å¯ä»¥ç”¨ `12K` å°±èƒ½ç»Ÿè®¡å®Œã€‚

### å†…éƒ¨å®žçŽ°

HyperLogLog çš„å®žçŽ°æ¶‰åŠåˆ°å¾ˆå¤šæ•°å­¦é—®é¢˜ï¼Œå¤ªè´¹è„‘å­äº†ï¼Œæˆ‘ä¹Ÿæ²¡æœ‰æžæ‡‚ï¼Œå¦‚æžœä½ æƒ³äº†è§£ä¸€ä¸‹ï¼Œè¯¾ä¸‹å¯ä»¥çœ‹çœ‹è¿™ä¸ªï¼š[HyperLogLog](https://en.wikipedia.org/wiki/HyperLogLog)ã€‚

### å¸¸è§å‘½ä»¤

HyperLogLog å‘½ä»¤å¾ˆå°‘ï¼Œå°±ä¸‰ä¸ªã€‚

```shell
# æ·»åŠ æŒ‡å®šå…ƒç´ åˆ° HyperLogLog ä¸­
PFADD key element [element ...]

# è¿”å›žç»™å®š HyperLogLog çš„åŸºæ•°ä¼°ç®—å€¼ã€‚
PFCOUNT key [key ...]

# å°†å¤šä¸ª HyperLogLog åˆå¹¶ä¸ºä¸€ä¸ª HyperLogLog
PFMERGE destkey sourcekey [sourcekey ...]
```

### åº”ç”¨åœºæ™¯

#### ç™¾ä¸‡çº§ç½‘é¡µ UA (User Agent) è®¡æ•°

Redis HyperLogLog  ä¼˜åŠ¿åœ¨äºŽåªéœ€è¦èŠ±è´¹ 12 KB å†…å­˜ï¼Œå°±å¯ä»¥è®¡ç®—æŽ¥è¿‘ 2^64 ä¸ªå…ƒç´ çš„åŸºæ•°ï¼Œå’Œå…ƒç´ è¶Šå¤šå°±è¶Šè€—è´¹å†…å­˜çš„ Set å’Œ Hash ç±»åž‹ç›¸æ¯”ï¼ŒHyperLogLog å°±éžå¸¸èŠ‚çœç©ºé—´ã€‚

æ‰€ä»¥ï¼Œéžå¸¸é€‚åˆç»Ÿè®¡ç™¾ä¸‡çº§ä»¥ä¸Šçš„ç½‘é¡µ UA çš„åœºæ™¯ã€‚

åœ¨ç»Ÿè®¡ UA æ—¶ï¼Œä½ å¯ä»¥ç”¨ PFADD å‘½ä»¤ï¼ˆç”¨äºŽå‘ HyperLogLog ä¸­æ·»åŠ æ–°å…ƒç´ ï¼‰æŠŠè®¿é—®é¡µé¢çš„æ¯ä¸ªç”¨æˆ·éƒ½æ·»åŠ åˆ° HyperLogLog ä¸­ã€‚

```shell
PFADD page1:ua user1 user2 user3 user4 user5
```

æŽ¥ä¸‹æ¥ï¼Œå°±å¯ä»¥ç”¨ PFCOUNT å‘½ä»¤ç›´æŽ¥èŽ·å¾— page1 çš„ UA å€¼äº†ï¼Œè¿™ä¸ªå‘½ä»¤çš„ä½œç”¨å°±æ˜¯è¿”å›ž HyperLogLog çš„ç»Ÿè®¡ç»“æžœã€‚

```shell
PFCOUNT page1:ua
```

ä¸è¿‡ï¼Œæœ‰ä¸€ç‚¹éœ€è¦ä½ æ³¨æ„ä¸€ä¸‹ï¼ŒHyperLogLog çš„ç»Ÿè®¡è§„åˆ™æ˜¯åŸºäºŽæ¦‚çŽ‡å®Œæˆçš„ï¼Œæ‰€ä»¥å®ƒç»™å‡ºçš„ç»Ÿè®¡ç»“æžœæ˜¯æœ‰ä¸€å®šè¯¯å·®çš„ï¼Œæ ‡å‡†è¯¯ç®—çŽ‡æ˜¯ 0.81%ã€‚

è¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œä½ ä½¿ç”¨ HyperLogLog ç»Ÿè®¡çš„ UA æ˜¯ 100 ä¸‡ï¼Œä½†å®žé™…çš„ UA å¯èƒ½æ˜¯ 101 ä¸‡ã€‚è™½ç„¶è¯¯å·®çŽ‡ä¸ç®—å¤§ï¼Œä½†æ˜¯ï¼Œå¦‚æžœä½ éœ€è¦ç²¾ç¡®ç»Ÿè®¡ç»“æžœçš„è¯ï¼Œæœ€å¥½è¿˜æ˜¯ç»§ç»­ç”¨ Set æˆ– Hash ç±»åž‹ã€‚

## GEO

Redis GEO æ˜¯ Redis 3.2 ç‰ˆæœ¬æ–°å¢žçš„æ•°æ®ç±»åž‹ï¼Œä¸»è¦ç”¨äºŽå­˜å‚¨åœ°ç†ä½ç½®ä¿¡æ¯ï¼Œå¹¶å¯¹å­˜å‚¨çš„ä¿¡æ¯è¿›è¡Œæ“ä½œã€‚

åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œæˆ‘ä»¬è¶Šæ¥è¶Šä¾èµ–æœç´¢â€œé™„è¿‘çš„é¤é¦†â€ã€åœ¨æ‰“è½¦è½¯ä»¶ä¸Šå«è½¦ï¼Œè¿™äº›éƒ½ç¦»ä¸å¼€åŸºäºŽä½ç½®ä¿¡æ¯æœåŠ¡ï¼ˆLocation-Based Serviceï¼ŒLBSï¼‰çš„åº”ç”¨ã€‚LBS åº”ç”¨è®¿é—®çš„æ•°æ®æ˜¯å’Œäººæˆ–ç‰©å…³è”çš„ä¸€ç»„ç»çº¬åº¦ä¿¡æ¯ï¼Œè€Œä¸”è¦èƒ½æŸ¥è¯¢ç›¸é‚»çš„ç»çº¬åº¦èŒƒå›´ï¼ŒGEO å°±éžå¸¸é€‚åˆåº”ç”¨åœ¨ LBS æœåŠ¡çš„åœºæ™¯ä¸­ã€‚

### å†…éƒ¨å®žçŽ°

GEO æœ¬èº«å¹¶æ²¡æœ‰è®¾è®¡æ–°çš„åº•å±‚æ•°æ®ç»“æž„ï¼Œè€Œæ˜¯ç›´æŽ¥ä½¿ç”¨äº† Sorted Set é›†åˆç±»åž‹ã€‚

GEO ç±»åž‹ä½¿ç”¨ GeoHash ç¼–ç æ–¹æ³•å®žçŽ°äº†ç»çº¬åº¦åˆ° Sorted Set ä¸­å…ƒç´ æƒé‡åˆ†æ•°çš„è½¬æ¢ï¼Œè¿™å…¶ä¸­çš„ä¸¤ä¸ªå…³é”®æœºåˆ¶å°±æ˜¯ã€Œå¯¹äºŒç»´åœ°å›¾åšåŒºé—´åˆ’åˆ†ã€å’Œã€Œå¯¹åŒºé—´è¿›è¡Œç¼–ç ã€ã€‚ä¸€ç»„ç»çº¬åº¦è½åœ¨æŸä¸ªåŒºé—´åŽï¼Œå°±ç”¨åŒºé—´çš„ç¼–ç å€¼æ¥è¡¨ç¤ºï¼Œå¹¶æŠŠç¼–ç å€¼ä½œä¸º Sorted Set å…ƒç´ çš„æƒé‡åˆ†æ•°ã€‚

è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠç»çº¬åº¦ä¿å­˜åˆ° Sorted Set ä¸­ï¼Œåˆ©ç”¨ Sorted Set æä¾›çš„â€œæŒ‰æƒé‡è¿›è¡Œæœ‰åºèŒƒå›´æŸ¥æ‰¾â€çš„ç‰¹æ€§ï¼Œå®žçŽ° LBS æœåŠ¡ä¸­é¢‘ç¹ä½¿ç”¨çš„â€œæœç´¢é™„è¿‘â€çš„éœ€æ±‚ã€‚

### å¸¸ç”¨å‘½ä»¤

```shell
# å­˜å‚¨æŒ‡å®šçš„åœ°ç†ç©ºé—´ä½ç½®ï¼Œå¯ä»¥å°†ä¸€ä¸ªæˆ–å¤šä¸ªç»åº¦(longitude)ã€çº¬åº¦(latitude)ã€ä½ç½®åç§°(member)æ·»åŠ åˆ°æŒ‡å®šçš„ key ä¸­ã€‚
GEOADD key longitude latitude member [longitude latitude member ...]

# ä»Žç»™å®šçš„ key é‡Œè¿”å›žæ‰€æœ‰æŒ‡å®šåç§°(member)çš„ä½ç½®ï¼ˆç»åº¦å’Œçº¬åº¦ï¼‰ï¼Œä¸å­˜åœ¨çš„è¿”å›ž nilã€‚
GEOPOS key member [member ...]

# è¿”å›žä¸¤ä¸ªç»™å®šä½ç½®ä¹‹é—´çš„è·ç¦»ã€‚
GEODIST key member1 member2 [m|km|ft|mi]

# æ ¹æ®ç”¨æˆ·ç»™å®šçš„ç»çº¬åº¦åæ ‡æ¥èŽ·å–æŒ‡å®šèŒƒå›´å†…çš„åœ°ç†ä½ç½®é›†åˆã€‚
GEORADIUS key longitude latitude radius m|km|ft|mi [WITHCOORD] [WITHDIST] [WITHHASH] [COUNT count] [ASC|DESC] [STORE key] [STOREDIST key]
```

### åº”ç”¨åœºæ™¯

#### æ»´æ»´å«è½¦

è¿™é‡Œä»¥æ»´æ»´å«è½¦çš„åœºæ™¯ä¸ºä¾‹ï¼Œä»‹ç»ä¸‹å…·ä½“å¦‚ä½•ä½¿ç”¨ GEO å‘½ä»¤ï¼šGEOADD å’Œ GEORADIUS è¿™ä¸¤ä¸ªå‘½ä»¤ã€‚

å‡è®¾è½¦è¾† ID æ˜¯ 33ï¼Œç»çº¬åº¦ä½ç½®æ˜¯ï¼ˆ116.034579ï¼Œ39.030452ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ª GEO é›†åˆä¿å­˜æ‰€æœ‰è½¦è¾†çš„ç»çº¬åº¦ï¼Œé›†åˆ key æ˜¯ cars:locationsã€‚

æ‰§è¡Œä¸‹é¢çš„è¿™ä¸ªå‘½ä»¤ï¼Œå°±å¯ä»¥æŠŠ ID å·ä¸º 33 çš„è½¦è¾†çš„å½“å‰ç»çº¬åº¦ä½ç½®å­˜å…¥ GEO é›†åˆä¸­ï¼š

```shell
GEOADD cars:locations 116.034579 39.030452 33
```

å½“ç”¨æˆ·æƒ³è¦å¯»æ‰¾è‡ªå·±é™„è¿‘çš„ç½‘çº¦è½¦æ—¶ï¼ŒLBS åº”ç”¨å°±å¯ä»¥ä½¿ç”¨ GEORADIUS å‘½ä»¤ã€‚

ä¾‹å¦‚ï¼ŒLBS åº”ç”¨æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ—¶ï¼ŒRedis ä¼šæ ¹æ®è¾“å…¥çš„ç”¨æˆ·çš„ç»çº¬åº¦ä¿¡æ¯ï¼ˆ116.054579ï¼Œ39.030452ï¼‰ï¼ŒæŸ¥æ‰¾ä»¥è¿™ä¸ªç»çº¬åº¦ä¸ºä¸­å¿ƒçš„ 5 å…¬é‡Œå†…çš„è½¦è¾†ä¿¡æ¯ï¼Œå¹¶è¿”å›žç»™ LBS åº”ç”¨ã€‚

```shell
GEORADIUS cars:locations 116.054579 39.030452 5 km ASC COUNT 10
```

## Stream

### ä»‹ç»

Redis Stream æ˜¯ Redis 5.0 ç‰ˆæœ¬æ–°å¢žåŠ çš„æ•°æ®ç±»åž‹ï¼ŒRedis ä¸“é—¨ä¸ºæ¶ˆæ¯é˜Ÿåˆ—è®¾è®¡çš„æ•°æ®ç±»åž‹ã€‚

åœ¨ Redis 5.0 Stream æ²¡å‡ºæ¥ä¹‹å‰ï¼Œæ¶ˆæ¯é˜Ÿåˆ—çš„å®žçŽ°æ–¹å¼éƒ½æœ‰ç€å„è‡ªçš„ç¼ºé™·ï¼Œä¾‹å¦‚ï¼š

- å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œä¸èƒ½æŒä¹…åŒ–ä¹Ÿå°±æ— æ³•å¯é çš„ä¿å­˜æ¶ˆæ¯ï¼Œå¹¶ä¸”å¯¹äºŽç¦»çº¿é‡è¿žçš„å®¢æˆ·ç«¯ä¸èƒ½è¯»å–åŽ†å²æ¶ˆæ¯çš„ç¼ºé™·ï¼›
- List å®žçŽ°æ¶ˆæ¯é˜Ÿåˆ—çš„æ–¹å¼ä¸èƒ½é‡å¤æ¶ˆè´¹ï¼Œä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹å®Œå°±ä¼šè¢«åˆ é™¤ï¼Œè€Œä¸”ç”Ÿäº§è€…éœ€è¦è‡ªè¡Œå®žçŽ°å…¨å±€å”¯ä¸€ IDã€‚

åŸºäºŽä»¥ä¸Šé—®é¢˜ï¼ŒRedis 5.0 ä¾¿æŽ¨å‡ºäº† Stream ç±»åž‹ä¹Ÿæ˜¯æ­¤ç‰ˆæœ¬æœ€é‡è¦çš„åŠŸèƒ½ï¼Œç”¨äºŽå®Œç¾Žåœ°å®žçŽ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ƒæ”¯æŒæ¶ˆæ¯çš„æŒä¹…åŒ–ã€æ”¯æŒè‡ªåŠ¨ç”Ÿæˆå…¨å±€å”¯ä¸€ IDã€æ”¯æŒ ack ç¡®è®¤æ¶ˆæ¯çš„æ¨¡å¼ã€æ”¯æŒæ¶ˆè´¹ç»„æ¨¡å¼ç­‰ï¼Œè®©æ¶ˆæ¯é˜Ÿåˆ—æ›´åŠ çš„ç¨³å®šå’Œå¯é ã€‚

### å¸¸è§å‘½ä»¤

Stream æ¶ˆæ¯é˜Ÿåˆ—æ“ä½œå‘½ä»¤ï¼š

- XADDï¼šæ’å…¥æ¶ˆæ¯ï¼Œä¿è¯æœ‰åºï¼Œå¯ä»¥è‡ªåŠ¨ç”Ÿæˆå…¨å±€å”¯ä¸€ IDï¼›
- XLENï¼šæŸ¥è¯¢æ¶ˆæ¯é•¿åº¦ï¼›
- XREADï¼šç”¨äºŽè¯»å–æ¶ˆæ¯ï¼Œå¯ä»¥æŒ‰ ID è¯»å–æ•°æ®ï¼›
- XDELï¼šæ ¹æ®æ¶ˆæ¯ ID åˆ é™¤æ¶ˆæ¯ï¼›
- DELï¼šåˆ é™¤æ•´ä¸ª Streamï¼›
- XRANGEï¼šè¯»å–åŒºé—´æ¶ˆæ¯
- XREADGROUPï¼šæŒ‰æ¶ˆè´¹ç»„å½¢å¼è¯»å–æ¶ˆæ¯ï¼›
- XPENDING å’Œ XACKï¼š
  - XPENDING å‘½ä»¤å¯ä»¥ç”¨æ¥æŸ¥è¯¢æ¯ä¸ªæ¶ˆè´¹ç»„å†…æ‰€æœ‰æ¶ˆè´¹è€…ã€Œå·²è¯»å–ã€ä½†å°šæœªç¡®è®¤ã€çš„æ¶ˆæ¯ï¼›
  -  XACK å‘½ä»¤ç”¨äºŽå‘æ¶ˆæ¯é˜Ÿåˆ—ç¡®è®¤æ¶ˆæ¯å¤„ç†å·²å®Œæˆï¼›

### åº”ç”¨åœºæ™¯

#### æ¶ˆæ¯é˜Ÿåˆ—

ç”Ÿäº§è€…é€šè¿‡ XADD å‘½ä»¤æ’å…¥ä¸€æ¡æ¶ˆæ¯ï¼š

```shell
# * è¡¨ç¤ºè®© Redis ä¸ºæ’å…¥çš„æ•°æ®è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ ID
# å¾€åç§°ä¸º mymq çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ’å…¥ä¸€æ¡æ¶ˆæ¯ï¼Œæ¶ˆæ¯çš„é”®æ˜¯ nameï¼Œå€¼æ˜¯ xiaolin
> XADD mymq * name xiaolin
"1654254953808-0"
```

æ’å…¥æˆåŠŸåŽä¼šè¿”å›žå…¨å±€å”¯ä¸€çš„ IDï¼š"1654254953808-0"ã€‚æ¶ˆæ¯çš„å…¨å±€å”¯ä¸€ ID ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š

- ç¬¬ä¸€éƒ¨åˆ†â€œ1654254953808â€æ˜¯æ•°æ®æ’å…¥æ—¶ï¼Œä»¥æ¯«ç§’ä¸ºå•ä½è®¡ç®—çš„å½“å‰æœåŠ¡å™¨æ—¶é—´ï¼›
- ç¬¬äºŒéƒ¨åˆ†è¡¨ç¤ºæ’å…¥æ¶ˆæ¯åœ¨å½“å‰æ¯«ç§’å†…çš„æ¶ˆæ¯åºå·ï¼Œè¿™æ˜¯ä»Ž 0 å¼€å§‹ç¼–å·çš„ã€‚ä¾‹å¦‚ï¼Œâ€œ1654254953808-0â€å°±è¡¨ç¤ºåœ¨â€œ1654254953808â€æ¯«ç§’å†…çš„ç¬¬ 1 æ¡æ¶ˆæ¯ã€‚

æ¶ˆè´¹è€…é€šè¿‡ XREAD å‘½ä»¤ä»Žæ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯æ—¶ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ªæ¶ˆæ¯ IDï¼Œå¹¶ä»Žè¿™ä¸ªæ¶ˆæ¯ ID çš„ä¸‹ä¸€æ¡æ¶ˆæ¯å¼€å§‹è¿›è¡Œè¯»å–ï¼ˆæ³¨æ„æ˜¯è¾“å…¥æ¶ˆæ¯ ID çš„ä¸‹ä¸€æ¡ä¿¡æ¯å¼€å§‹è¯»å–ï¼Œä¸æ˜¯æŸ¥è¯¢è¾“å…¥ ID çš„æ¶ˆæ¯ï¼‰ã€‚

```shell
# ä»Ž ID å·ä¸º 1654254953807-0 çš„æ¶ˆæ¯å¼€å§‹ï¼Œè¯»å–åŽç»­çš„æ‰€æœ‰æ¶ˆæ¯ï¼ˆç¤ºä¾‹ä¸­ä¸€å…± 1 æ¡ï¼‰ã€‚
> XREAD STREAMS mymq 1654254953807-0
1) 1) "mymq"
   2) 1) 1) "1654254953808-0"
         2) 1) "name"
            2) "xiaolin"
```

å¦‚æžœ**æƒ³è¦å®žçŽ°é˜»å¡žè¯»ï¼ˆå½“æ²¡æœ‰æ•°æ®æ—¶ï¼Œé˜»å¡žä½ï¼‰ï¼Œå¯ä»¥è°ƒç”¨ XRAED æ—¶è®¾å®š BLOCK é…ç½®é¡¹**ï¼Œå®žçŽ°ç±»ä¼¼äºŽ BRPOP çš„é˜»å¡žè¯»å–æ“ä½œã€‚

æ¯”å¦‚ï¼Œä¸‹é¢è¿™å‘½ä»¤ï¼Œè®¾ç½®äº† BLOCK 10000 çš„é…ç½®é¡¹ï¼Œ10000 çš„å•ä½æ˜¯æ¯«ç§’ï¼Œè¡¨æ˜Ž XREAD åœ¨è¯»å–æœ€æ–°æ¶ˆæ¯æ—¶ï¼Œå¦‚æžœæ²¡æœ‰æ¶ˆæ¯åˆ°æ¥ï¼ŒXREAD å°†é˜»å¡ž 10000 æ¯«ç§’ï¼ˆå³ 10 ç§’ï¼‰ï¼Œç„¶åŽå†è¿”å›žã€‚

```shell
# å‘½ä»¤æœ€åŽçš„â€œ$â€ç¬¦å·è¡¨ç¤ºè¯»å–æœ€æ–°çš„æ¶ˆæ¯
> XREAD BLOCK 10000 STREAMS mymq $
(nil)
(10.00s)
```

Stream çš„åŸºç¡€æ–¹æ³•ï¼Œä½¿ç”¨ xadd å­˜å…¥æ¶ˆæ¯å’Œ xread å¾ªçŽ¯é˜»å¡žè¯»å–æ¶ˆæ¯çš„æ–¹å¼å¯ä»¥å®žçŽ°ç®€æ˜“ç‰ˆçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œäº¤äº’æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/æ•°æ®ç±»åž‹/Streamç®€æ˜“.png)

> å‰é¢ä»‹ç»çš„è¿™äº›æ“ä½œ List ä¹Ÿæ”¯æŒçš„ï¼ŒæŽ¥ä¸‹æ¥çœ‹çœ‹ Stream ç‰¹æœ‰çš„åŠŸèƒ½ã€‚

Stream å¯ä»¥ä»¥ä½¿ç”¨ **XGROUP åˆ›å»ºæ¶ˆè´¹ç»„**ï¼Œåˆ›å»ºæ¶ˆè´¹ç»„ä¹‹åŽï¼ŒStream å¯ä»¥ä½¿ç”¨ XREADGROUP å‘½ä»¤è®©æ¶ˆè´¹ç»„å†…çš„æ¶ˆè´¹è€…è¯»å–æ¶ˆæ¯ã€‚

åˆ›å»ºä¸¤ä¸ªæ¶ˆè´¹ç»„ï¼Œè¿™ä¸¤ä¸ªæ¶ˆè´¹ç»„æ¶ˆè´¹çš„æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ mymqï¼Œéƒ½æŒ‡å®šä»Žç¬¬ä¸€æ¡æ¶ˆæ¯å¼€å§‹è¯»å–ï¼š

```shell
# åˆ›å»ºä¸€ä¸ªåä¸º group1 çš„æ¶ˆè´¹ç»„ï¼Œ0-0 è¡¨ç¤ºä»Žç¬¬ä¸€æ¡æ¶ˆæ¯å¼€å§‹è¯»å–ã€‚
> XGROUP CREATE mymq group1 0-0
OK
# åˆ›å»ºä¸€ä¸ªåä¸º group2 çš„æ¶ˆè´¹ç»„ï¼Œ0-0 è¡¨ç¤ºä»Žç¬¬ä¸€æ¡æ¶ˆæ¯å¼€å§‹è¯»å–ã€‚
> XGROUP CREATE mymq group2 0-0
OK
```

æ¶ˆè´¹ç»„ group1 å†…çš„æ¶ˆè´¹è€…  consumer1 ä»Ž mymq æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–æ‰€æœ‰æ¶ˆæ¯çš„å‘½ä»¤å¦‚ä¸‹ï¼š

```shell
# å‘½ä»¤æœ€åŽçš„å‚æ•°â€œ>â€ï¼Œè¡¨ç¤ºä»Žç¬¬ä¸€æ¡å°šæœªè¢«æ¶ˆè´¹çš„æ¶ˆæ¯å¼€å§‹è¯»å–ã€‚
> XREADGROUP GROUP group1 consumer1 STREAMS mymq >
1) 1) "mymq"
   2) 1) 1) "1654254953808-0"
         2) 1) "name"
            2) "xiaolin"
```

**æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¸€æ—¦è¢«æ¶ˆè´¹ç»„é‡Œçš„ä¸€ä¸ªæ¶ˆè´¹è€…è¯»å–äº†ï¼Œå°±ä¸èƒ½å†è¢«è¯¥æ¶ˆè´¹ç»„å†…çš„å…¶ä»–æ¶ˆè´¹è€…è¯»å–äº†ï¼Œå³åŒä¸€ä¸ªæ¶ˆè´¹ç»„é‡Œçš„æ¶ˆè´¹è€…ä¸èƒ½æ¶ˆè´¹åŒä¸€æ¡æ¶ˆæ¯**ã€‚

æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬æ‰§è¡Œå®Œåˆšæ‰çš„ XREADGROUP å‘½ä»¤åŽï¼Œå†æ‰§è¡Œä¸€æ¬¡åŒæ ·çš„å‘½ä»¤ï¼Œæ­¤æ—¶è¯»åˆ°çš„å°±æ˜¯ç©ºå€¼äº†ï¼š

```shell
> XREADGROUP GROUP group1 consumer1 STREAMS mymq >
(nil)
```

ä½†æ˜¯ï¼Œ**ä¸åŒæ¶ˆè´¹ç»„çš„æ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹åŒä¸€æ¡æ¶ˆæ¯ï¼ˆä½†æ˜¯æœ‰å‰ææ¡ä»¶ï¼Œåˆ›å»ºæ¶ˆæ¯ç»„çš„æ—¶å€™ï¼Œä¸åŒæ¶ˆè´¹ç»„æŒ‡å®šäº†ç›¸åŒä½ç½®å¼€å§‹è¯»å–æ¶ˆæ¯ï¼‰**ã€‚

æ¯”å¦‚è¯´ï¼Œåˆšæ‰ group1 æ¶ˆè´¹ç»„é‡Œçš„ consumer1 æ¶ˆè´¹è€…æ¶ˆè´¹äº†ä¸€æ¡ id ä¸º 1654254953808-0 çš„æ¶ˆæ¯ï¼ŒçŽ°åœ¨ç”¨ group2 æ¶ˆè´¹ç»„é‡Œçš„ consumer1 æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯ï¼š

```shell
> XREADGROUP GROUP group2 consumer1 STREAMS mymq >
1) 1) "mymq"
   2) 1) 1) "1654254953808-0"
         2) 1) "name"
            2) "xiaolin"
```

å› ä¸ºæˆ‘åˆ›å»ºä¸¤ç»„çš„æ¶ˆè´¹ç»„éƒ½æ˜¯ä»Žç¬¬ä¸€æ¡æ¶ˆæ¯å¼€å§‹è¯»å–ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ°ç¬¬äºŒç»„çš„æ¶ˆè´¹è€…ä¾ç„¶å¯ä»¥æ¶ˆè´¹ id ä¸º 1654254953808-0 çš„è¿™ä¸€æ¡æ¶ˆæ¯ã€‚å› æ­¤ï¼Œä¸åŒçš„æ¶ˆè´¹ç»„çš„æ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹åŒä¸€æ¡æ¶ˆæ¯ã€‚

ä½¿ç”¨æ¶ˆè´¹ç»„çš„ç›®çš„æ˜¯è®©ç»„å†…çš„å¤šä¸ªæ¶ˆè´¹è€…å…±åŒåˆ†æ‹…è¯»å–æ¶ˆæ¯ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šè®©æ¯ä¸ªæ¶ˆè´¹è€…è¯»å–éƒ¨åˆ†æ¶ˆæ¯ï¼Œä»Žè€Œå®žçŽ°æ¶ˆæ¯è¯»å–è´Ÿè½½åœ¨å¤šä¸ªæ¶ˆè´¹è€…é—´æ˜¯å‡è¡¡åˆ†å¸ƒçš„ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬æ‰§è¡Œä¸‹åˆ—å‘½ä»¤ï¼Œè®© group2 ä¸­çš„ consumer1ã€2ã€3 å„è‡ªè¯»å–ä¸€æ¡æ¶ˆæ¯ã€‚

```shell
# è®© group2 ä¸­çš„ consumer1 ä»Ž mymq æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¶ˆè´¹ä¸€æ¡æ¶ˆæ¯
> XREADGROUP GROUP group2 consumer1 COUNT 1 STREAMS mymq >
1) 1) "mymq"
   2) 1) 1) "1654254953808-0"
         2) 1) "name"
            2) "xiaolin"
# è®© group2 ä¸­çš„ consumer2 ä»Ž mymq æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¶ˆè´¹ä¸€æ¡æ¶ˆæ¯
> XREADGROUP GROUP group2 consumer2 COUNT 1 STREAMS mymq >
1) 1) "mymq"
   2) 1) 1) "1654256265584-0"
         2) 1) "name"
            2) "xiaolincoding"
# è®© group2 ä¸­çš„ consumer3 ä»Ž mymq æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¶ˆè´¹ä¸€æ¡æ¶ˆæ¯
> XREADGROUP GROUP group2 consumer3 COUNT 1 STREAMS mymq >
1) 1) "mymq"
   2) 1) 1) "1654256271337-0"
         2) 1) "name"
            2) "Tom"
```

> åŸºäºŽ Stream å®žçŽ°çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¦‚ä½•ä¿è¯æ¶ˆè´¹è€…åœ¨å‘ç”Ÿæ•…éšœæˆ–å®•æœºå†æ¬¡é‡å¯åŽï¼Œä»ç„¶å¯ä»¥è¯»å–æœªå¤„ç†å®Œçš„æ¶ˆæ¯ï¼Ÿ

Streams ä¼šè‡ªåŠ¨ä½¿ç”¨å†…éƒ¨é˜Ÿåˆ—ï¼ˆä¹Ÿç§°ä¸º PENDING Listï¼‰ç•™å­˜æ¶ˆè´¹ç»„é‡Œæ¯ä¸ªæ¶ˆè´¹è€…è¯»å–çš„æ¶ˆæ¯ï¼Œç›´åˆ°æ¶ˆè´¹è€…ä½¿ç”¨ XACK å‘½ä»¤é€šçŸ¥ Streamsâ€œæ¶ˆæ¯å·²ç»å¤„ç†å®Œæˆâ€ã€‚

æ¶ˆè´¹ç¡®è®¤å¢žåŠ äº†æ¶ˆæ¯çš„å¯é æ€§ï¼Œä¸€èˆ¬åœ¨ä¸šåŠ¡å¤„ç†å®Œæˆä¹‹åŽï¼Œéœ€è¦æ‰§è¡Œ XACK å‘½ä»¤ç¡®è®¤æ¶ˆæ¯å·²ç»è¢«æ¶ˆè´¹å®Œæˆï¼Œæ•´ä¸ªæµç¨‹çš„æ‰§è¡Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/æ•°æ®ç±»åž‹/æ¶ˆæ¯ç¡®è®¤.png)

å¦‚æžœæ¶ˆè´¹è€…æ²¡æœ‰æˆåŠŸå¤„ç†æ¶ˆæ¯ï¼Œå®ƒå°±ä¸ä¼šç»™ Streams å‘é€ XACK å‘½ä»¤ï¼Œæ¶ˆæ¯ä»ç„¶ä¼šç•™å­˜ã€‚æ­¤æ—¶ï¼Œ**æ¶ˆè´¹è€…å¯ä»¥åœ¨é‡å¯åŽï¼Œç”¨ XPENDING å‘½ä»¤æŸ¥çœ‹å·²è¯»å–ã€ä½†å°šæœªç¡®è®¤å¤„ç†å®Œæˆçš„æ¶ˆæ¯**ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬æ¥æŸ¥çœ‹ä¸€ä¸‹ group2 ä¸­å„ä¸ªæ¶ˆè´¹è€…å·²è¯»å–ã€ä½†å°šæœªç¡®è®¤çš„æ¶ˆæ¯ä¸ªæ•°ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š

```shell
127.0.0.1:6379> XPENDING mymq group2
1) (integer) 3
2) "1654254953808-0"  # è¡¨ç¤º group2 ä¸­æ‰€æœ‰æ¶ˆè´¹è€…è¯»å–çš„æ¶ˆæ¯æœ€å° ID
3) "1654256271337-0"  # è¡¨ç¤º group2 ä¸­æ‰€æœ‰æ¶ˆè´¹è€…è¯»å–çš„æ¶ˆæ¯æœ€å¤§ ID
4) 1) 1) "consumer1"
      2) "1"
   2) 1) "consumer2"
      2) "1"
   3) 1) "consumer3"
      2) "1"
```

å¦‚æžœæƒ³æŸ¥çœ‹æŸä¸ªæ¶ˆè´¹è€…å…·ä½“è¯»å–äº†å“ªäº›æ•°æ®ï¼Œå¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š

```shell
# æŸ¥çœ‹ group2 é‡Œ consumer2 å·²ä»Ž mymq æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–äº†å“ªäº›æ¶ˆæ¯
> XPENDING mymq group2 - + 10 consumer2
1) 1) "1654256265584-0"
   2) "consumer2"
   3) (integer) 410700
   4) (integer) 1
```

å¯ä»¥çœ‹åˆ°ï¼Œconsumer2 å·²è¯»å–çš„æ¶ˆæ¯çš„ ID æ˜¯ 1654256265584-0ã€‚

**ä¸€æ—¦æ¶ˆæ¯ 1654256265584-0 è¢« consumer2 å¤„ç†äº†ï¼Œconsumer2 å°±å¯ä»¥ä½¿ç”¨ XACK å‘½ä»¤é€šçŸ¥ Streamsï¼Œç„¶åŽè¿™æ¡æ¶ˆæ¯å°±ä¼šè¢«åˆ é™¤**ã€‚

```shell
> XACK mymq group2 1654256265584-0
(integer) 1
```

å½“æˆ‘ä»¬å†ä½¿ç”¨ XPENDING å‘½ä»¤æŸ¥çœ‹æ—¶ï¼Œå°±å¯ä»¥çœ‹åˆ°ï¼Œconsumer2 å·²ç»æ²¡æœ‰å·²è¯»å–ã€ä½†å°šæœªç¡®è®¤å¤„ç†çš„æ¶ˆæ¯äº†ã€‚

```shell
> XPENDING mymq group2 - + 10 consumer2
(empty array)
```

å¥½äº†ï¼ŒåŸºäºŽ Stream å®žçŽ°çš„æ¶ˆæ¯é˜Ÿåˆ—å°±è¯´åˆ°è¿™é‡Œäº†ï¼Œå°ç»“ä¸€ä¸‹ï¼š

- æ¶ˆæ¯ä¿åºï¼šXADD/XREAD
- é˜»å¡žè¯»å–ï¼šXREAD block
- é‡å¤æ¶ˆæ¯å¤„ç†ï¼šStream åœ¨ä½¿ç”¨  XADD å‘½ä»¤ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆå…¨å±€å”¯ä¸€ IDï¼›
- æ¶ˆæ¯å¯é æ€§ï¼šå†…éƒ¨ä½¿ç”¨ PENDING List è‡ªåŠ¨ä¿å­˜æ¶ˆæ¯ï¼Œä½¿ç”¨ XPENDING å‘½ä»¤æŸ¥çœ‹æ¶ˆè´¹ç»„å·²ç»è¯»å–ä½†æ˜¯æœªè¢«ç¡®è®¤çš„æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ä½¿ç”¨ XACK ç¡®è®¤æ¶ˆæ¯ï¼›
- æ”¯æŒæ¶ˆè´¹ç»„å½¢å¼æ¶ˆè´¹æ•°æ®

> Redis åŸºäºŽ Stream æ¶ˆæ¯é˜Ÿåˆ—ä¸Žä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›å·®è·ï¼Ÿ

ä¸€ä¸ªä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¿…é¡»è¦åšåˆ°ä¸¤å¤§å—ï¼š

- æ¶ˆæ¯ä¸ä¸¢ã€‚
- æ¶ˆæ¯å¯å †ç§¯ã€‚

*1ã€Redis Stream æ¶ˆæ¯ä¼šä¸¢å¤±å—ï¼Ÿ*

ä½¿ç”¨ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå…¶å®žå°±åˆ†ä¸ºä¸‰å¤§å—ï¼š**ç”Ÿäº§è€…ã€é˜Ÿåˆ—ä¸­é—´ä»¶ã€æ¶ˆè´¹è€…**ï¼Œæ‰€ä»¥è¦ä¿è¯æ¶ˆæ¯å°±æ˜¯ä¿è¯ä¸‰ä¸ªçŽ¯èŠ‚éƒ½ä¸èƒ½ä¸¢å¤±æ•°æ®ã€‚

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/æ•°æ®ç±»åž‹/æ¶ˆæ¯é˜Ÿåˆ—ä¸‰ä¸ªé˜¶æ®µ.png)

Redis Stream æ¶ˆæ¯é˜Ÿåˆ—èƒ½ä¸èƒ½ä¿è¯ä¸‰ä¸ªçŽ¯èŠ‚éƒ½ä¸ä¸¢å¤±æ•°æ®ï¼Ÿ

- Redis ç”Ÿäº§è€…ä¼šä¸ä¼šä¸¢æ¶ˆæ¯ï¼Ÿç”Ÿäº§è€…ä¼šä¸ä¼šä¸¢æ¶ˆæ¯ï¼Œå–å†³äºŽç”Ÿäº§è€…å¯¹äºŽå¼‚å¸¸æƒ…å†µçš„å¤„ç†æ˜¯å¦åˆç†ã€‚ä»Žæ¶ˆæ¯è¢«ç”Ÿäº§å‡ºæ¥ï¼Œç„¶åŽæäº¤ç»™ MQ çš„è¿‡ç¨‹ä¸­ï¼Œåªè¦èƒ½æ­£å¸¸æ”¶åˆ°ï¼ˆMQ ä¸­é—´ä»¶ï¼‰çš„ ack ç¡®è®¤å“åº”ï¼Œå°±è¡¨ç¤ºå‘é€æˆåŠŸï¼Œæ‰€ä»¥åªè¦å¤„ç†å¥½è¿”å›žå€¼å’Œå¼‚å¸¸ï¼Œå¦‚æžœè¿”å›žå¼‚å¸¸åˆ™è¿›è¡Œæ¶ˆæ¯é‡å‘ï¼Œé‚£ä¹ˆè¿™ä¸ªé˜¶æ®µæ˜¯ä¸ä¼šå‡ºçŽ°æ¶ˆæ¯ä¸¢å¤±çš„ã€‚
- Redis æ¶ˆè´¹è€…ä¼šä¸ä¼šä¸¢æ¶ˆæ¯ï¼Ÿä¸ä¼šï¼Œå› ä¸º Streamï¼ˆMQ ä¸­é—´ä»¶ï¼‰ä¼šè‡ªåŠ¨ä½¿ç”¨å†…éƒ¨é˜Ÿåˆ—ï¼ˆä¹Ÿç§°ä¸º PENDING Listï¼‰ç•™å­˜æ¶ˆè´¹ç»„é‡Œæ¯ä¸ªæ¶ˆè´¹è€…è¯»å–çš„æ¶ˆæ¯ï¼Œä½†æ˜¯æœªè¢«ç¡®è®¤çš„æ¶ˆæ¯ã€‚æ¶ˆè´¹è€…å¯ä»¥åœ¨é‡å¯åŽï¼Œç”¨ XPENDING å‘½ä»¤æŸ¥çœ‹å·²è¯»å–ã€ä½†å°šæœªç¡®è®¤å¤„ç†å®Œæˆçš„æ¶ˆæ¯ã€‚ç­‰åˆ°æ¶ˆè´¹è€…æ‰§è¡Œå®Œä¸šåŠ¡é€»è¾‘åŽï¼Œå†å‘é€æ¶ˆè´¹ç¡®è®¤ XACK å‘½ä»¤ï¼Œä¹Ÿèƒ½ä¿è¯æ¶ˆæ¯çš„ä¸ä¸¢å¤±ã€‚
- Redis æ¶ˆæ¯ä¸­é—´ä»¶ä¼šä¸ä¼šä¸¢æ¶ˆæ¯ï¼Ÿ**ä¼š**ï¼ŒRedis åœ¨ä»¥ä¸‹ 2 ä¸ªåœºæ™¯ä¸‹ï¼Œéƒ½ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼š
  - AOF æŒä¹…åŒ–é…ç½®ä¸ºæ¯ç§’å†™ç›˜ï¼Œä½†è¿™ä¸ªå†™ç›˜è¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ï¼ŒRedis å®•æœºæ—¶ä¼šå­˜åœ¨æ•°æ®ä¸¢å¤±çš„å¯èƒ½
  - ä¸»ä»Žå¤åˆ¶ä¹Ÿæ˜¯å¼‚æ­¥çš„ï¼Œ[ä¸»ä»Žåˆ‡æ¢æ—¶ï¼Œä¹Ÿå­˜åœ¨ä¸¢å¤±æ•°æ®çš„å¯èƒ½](https://xiaolincoding.com/redis/cluster/master_slave_replication.html#redis-%E4%B8%BB%E4%BB%8E%E5%88%87%E6%8D%A2%E5%A6%82%E4%BD%95%E5%87%8F%E5%B0%91%E6%95%B0%E6%8D%AE%E4%B8%A2%E5%A4%B1)ã€‚

å¯ä»¥çœ‹åˆ°ï¼ŒRedis åœ¨é˜Ÿåˆ—ä¸­é—´ä»¶çŽ¯èŠ‚æ— æ³•ä¿è¯æ¶ˆæ¯ä¸ä¸¢ã€‚åƒ RabbitMQ æˆ– Kafka è¿™ç±»ä¸“ä¸šçš„é˜Ÿåˆ—ä¸­é—´ä»¶ï¼Œåœ¨ä½¿ç”¨æ—¶æ˜¯éƒ¨ç½²ä¸€ä¸ªé›†ç¾¤ï¼Œç”Ÿäº§è€…åœ¨å‘å¸ƒæ¶ˆæ¯æ—¶ï¼Œé˜Ÿåˆ—ä¸­é—´ä»¶é€šå¸¸ä¼šå†™ã€Œå¤šä¸ªèŠ‚ç‚¹ã€ï¼Œä¹Ÿå°±æ˜¯æœ‰å¤šä¸ªå‰¯æœ¬ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå³ä¾¿å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œä¹Ÿèƒ½ä¿è¯é›†ç¾¤çš„æ•°æ®ä¸ä¸¢å¤±ã€‚

*2ã€Redis Stream æ¶ˆæ¯å¯å †ç§¯å—ï¼Ÿ*

Redis çš„æ•°æ®éƒ½å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œè¿™å°±æ„å‘³ç€ä¸€æ—¦å‘ç”Ÿæ¶ˆæ¯ç§¯åŽ‹ï¼Œåˆ™ä¼šå¯¼è‡´ Redis çš„å†…å­˜æŒç»­å¢žé•¿ï¼Œå¦‚æžœè¶…è¿‡æœºå™¨å†…å­˜ä¸Šé™ï¼Œå°±ä¼šé¢ä¸´è¢« OOM çš„é£Žé™©ã€‚

æ‰€ä»¥ Redis çš„ Stream æä¾›äº†å¯ä»¥æŒ‡å®šé˜Ÿåˆ—æœ€å¤§é•¿åº¦çš„åŠŸèƒ½ï¼Œå°±æ˜¯ä¸ºäº†é¿å…è¿™ç§æƒ…å†µå‘ç”Ÿã€‚

å½“æŒ‡å®šé˜Ÿåˆ—æœ€å¤§é•¿åº¦æ—¶ï¼Œé˜Ÿåˆ—é•¿åº¦è¶…è¿‡ä¸Šé™åŽï¼Œæ—§æ¶ˆæ¯ä¼šè¢«åˆ é™¤ï¼Œåªä¿ç•™å›ºå®šé•¿åº¦çš„æ–°æ¶ˆæ¯ã€‚è¿™ä¹ˆæ¥çœ‹ï¼ŒStream åœ¨æ¶ˆæ¯ç§¯åŽ‹æ—¶ï¼Œå¦‚æžœæŒ‡å®šäº†æœ€å¤§é•¿åº¦ï¼Œè¿˜æ˜¯æœ‰å¯èƒ½ä¸¢å¤±æ¶ˆæ¯çš„ã€‚

ä½† Kafkaã€RabbitMQ ä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—å®ƒä»¬çš„æ•°æ®éƒ½æ˜¯å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼Œå½“æ¶ˆæ¯ç§¯åŽ‹æ—¶ï¼Œæ— éžå°±æ˜¯å¤šå ç”¨ä¸€äº›ç£ç›˜ç©ºé—´ã€‚

å› æ­¤ï¼ŒæŠŠ Redis å½“ä½œé˜Ÿåˆ—æ¥ä½¿ç”¨æ—¶ï¼Œä¼šé¢ä¸´çš„ 2 ä¸ªé—®é¢˜ï¼š

- Redis æœ¬èº«å¯èƒ½ä¼šä¸¢æ•°æ®ï¼›
- é¢å¯¹æ¶ˆæ¯æŒ¤åŽ‹ï¼Œå†…å­˜èµ„æºä¼šç´§å¼ ï¼›

æ‰€ä»¥ï¼Œèƒ½ä¸èƒ½å°† Redis ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—æ¥ä½¿ç”¨ï¼Œå…³é”®çœ‹ä½ çš„ä¸šåŠ¡åœºæ™¯ï¼š

- å¦‚æžœä½ çš„ä¸šåŠ¡åœºæ™¯è¶³å¤Ÿç®€å•ï¼Œå¯¹äºŽæ•°æ®ä¸¢å¤±ä¸æ•æ„Ÿï¼Œè€Œä¸”æ¶ˆæ¯ç§¯åŽ‹æ¦‚çŽ‡æ¯”è¾ƒå°çš„æƒ…å†µä¸‹ï¼ŒæŠŠ Redis å½“ä½œé˜Ÿåˆ—æ˜¯å®Œå…¨å¯ä»¥çš„ã€‚
- å¦‚æžœä½ çš„ä¸šåŠ¡æœ‰æµ·é‡æ¶ˆæ¯ï¼Œæ¶ˆæ¯ç§¯åŽ‹çš„æ¦‚çŽ‡æ¯”è¾ƒå¤§ï¼Œå¹¶ä¸”ä¸èƒ½æŽ¥å—æ•°æ®ä¸¢å¤±ï¼Œé‚£ä¹ˆè¿˜æ˜¯ç”¨ä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶å§ã€‚

> è¡¥å……ï¼šRedis å‘å¸ƒ/è®¢é˜…æœºåˆ¶ä¸ºä»€ä¹ˆä¸å¯ä»¥ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ

å‘å¸ƒè®¢é˜…æœºåˆ¶å­˜åœ¨ä»¥ä¸‹ç¼ºç‚¹ï¼Œéƒ½æ˜¯è·Ÿä¸¢å¤±æ•°æ®æœ‰å…³ï¼š

1. å‘å¸ƒ/è®¢é˜…æœºåˆ¶æ²¡æœ‰åŸºäºŽä»»ä½•æ•°æ®ç±»åž‹å®žçŽ°ï¼Œæ‰€ä»¥ä¸å…·å¤‡ã€Œæ•°æ®æŒä¹…åŒ–ã€çš„èƒ½åŠ›ï¼Œä¹Ÿå°±æ˜¯å‘å¸ƒ/è®¢é˜…æœºåˆ¶çš„ç›¸å…³æ“ä½œï¼Œä¸ä¼šå†™å…¥åˆ° RDB å’Œ AOF ä¸­ï¼Œå½“ Redis å®•æœºé‡å¯ï¼Œå‘å¸ƒ/è®¢é˜…æœºåˆ¶çš„æ•°æ®ä¹Ÿä¼šå…¨éƒ¨ä¸¢å¤±ã€‚
2. å‘å¸ƒè®¢é˜…æ¨¡å¼æ˜¯â€œå‘åŽæ—¢å¿˜â€çš„å·¥ä½œæ¨¡å¼ï¼Œå¦‚æžœæœ‰è®¢é˜…è€…ç¦»çº¿é‡è¿žä¹‹åŽä¸èƒ½æ¶ˆè´¹ä¹‹å‰çš„åŽ†å²æ¶ˆæ¯ã€‚
3. å½“æ¶ˆè´¹ç«¯æœ‰ä¸€å®šçš„æ¶ˆæ¯ç§¯åŽ‹æ—¶ï¼Œä¹Ÿå°±æ˜¯ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹ä¸è¿‡æ¥æ—¶ï¼Œå¦‚æžœè¶…è¿‡ 32M æˆ–è€…æ˜¯ 60s å†…æŒç»­ä¿æŒåœ¨ 8M ä»¥ä¸Šï¼Œæ¶ˆè´¹ç«¯ä¼šè¢«å¼ºè¡Œæ–­å¼€ï¼Œè¿™ä¸ªå‚æ•°æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®çš„ï¼Œé»˜è®¤å€¼æ˜¯ `client-output-buffer-limit pubsub 32mb 8mb 60`ã€‚

æ‰€ä»¥ï¼Œå‘å¸ƒ/è®¢é˜…æœºåˆ¶åªé€‚åˆå³æ—¶é€šè®¯çš„åœºæ™¯ï¼Œæ¯”å¦‚[æž„å»ºå“¨å…µé›†ç¾¤](https://xiaolincoding.com/redis/cluster/sentinel.html#%E5%93%A8%E5%85%B5%E9%9B%86%E7%BE%A4%E6%98%AF%E5%A6%82%E4%BD%95%E7%BB%84%E6%88%90%E7%9A%84)çš„åœºæ™¯é‡‡ç”¨äº†å‘å¸ƒ/è®¢é˜…æœºåˆ¶ã€‚

## æ€»ç»“

Redis å¸¸è§çš„äº”ç§æ•°æ®ç±»åž‹ï¼š**Stringï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼ŒHashï¼ˆå“ˆå¸Œï¼‰ï¼ŒListï¼ˆåˆ—è¡¨ï¼‰ï¼ŒSetï¼ˆé›†åˆï¼‰åŠ Zset(sorted setï¼šæœ‰åºé›†åˆ)**ã€‚

è¿™äº”ç§æ•°æ®ç±»åž‹éƒ½ç”±å¤šç§æ•°æ®ç»“æž„å®žçŽ°çš„ï¼Œä¸»è¦æ˜¯å‡ºäºŽæ—¶é—´å’Œç©ºé—´çš„è€ƒè™‘ï¼Œå½“æ•°æ®é‡å°çš„æ—¶å€™ä½¿ç”¨æ›´ç®€å•çš„æ•°æ®ç»“æž„ï¼Œæœ‰åˆ©äºŽèŠ‚çœå†…å­˜ï¼Œæé«˜æ€§èƒ½ã€‚

è¿™äº”ç§æ•°æ®ç±»åž‹ä¸Žåº•å±‚æ•°æ®ç»“æž„å¯¹åº”å…³ç³»å›¾å¦‚ä¸‹ï¼Œå·¦è¾¹æ˜¯ Redis 3.0 ç‰ˆæœ¬çš„ï¼Œä¹Ÿå°±æ˜¯ã€ŠRedis è®¾è®¡ä¸Žå®žçŽ°ã€‹è¿™æœ¬ä¹¦è®²è§£çš„ç‰ˆæœ¬ï¼ŒçŽ°åœ¨çœ‹è¿˜æ˜¯æœ‰ç‚¹è¿‡æ—¶äº†ï¼Œå³è¾¹æ˜¯çŽ°åœ¨ Github æœ€æ–°çš„ Redis ä»£ç çš„ã€‚

![](https://img-blog.csdnimg.cn/img_convert/9fa26a74965efbf0f56b707a03bb9b7f.png)

å¯ä»¥çœ‹åˆ°ï¼ŒRedis æ•°æ®ç±»åž‹çš„åº•å±‚æ•°æ®ç»“æž„éšç€ç‰ˆæœ¬çš„æ›´æ–°ä¹Ÿæœ‰æ‰€ä¸åŒï¼Œæ¯”å¦‚ï¼š

- åœ¨ Redis 3.0 ç‰ˆæœ¬ä¸­ List å¯¹è±¡çš„åº•å±‚æ•°æ®ç»“æž„ç”±ã€ŒåŒå‘é“¾è¡¨ã€æˆ–ã€ŒåŽ‹ç¼©è¡¨åˆ—è¡¨ã€å®žçŽ°ï¼Œä½†æ˜¯åœ¨ 3.2 ç‰ˆæœ¬ä¹‹åŽï¼ŒList æ•°æ®ç±»åž‹åº•å±‚æ•°æ®ç»“æž„æ˜¯ç”± quicklist å®žçŽ°çš„ï¼›
- åœ¨æœ€æ–°çš„ Redis ä»£ç ä¸­ï¼ŒåŽ‹ç¼©åˆ—è¡¨æ•°æ®ç»“æž„å·²ç»åºŸå¼ƒäº†ï¼Œäº¤ç”± listpack æ•°æ®ç»“æž„æ¥å®žçŽ°äº†ã€‚

Redis äº”ç§æ•°æ®ç±»åž‹çš„åº”ç”¨åœºæ™¯ï¼š

- String ç±»åž‹çš„åº”ç”¨åœºæ™¯ï¼šç¼“å­˜å¯¹è±¡ã€å¸¸è§„è®¡æ•°ã€åˆ†å¸ƒå¼é”ã€å…±äº« session ä¿¡æ¯ç­‰ã€‚
- List ç±»åž‹çš„åº”ç”¨åœºæ™¯ï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆæœ‰ä¸¤ä¸ªé—®é¢˜ï¼š1. ç”Ÿäº§è€…éœ€è¦è‡ªè¡Œå®žçŽ°å…¨å±€å”¯ä¸€ IDï¼›2. ä¸èƒ½ä»¥æ¶ˆè´¹ç»„å½¢å¼æ¶ˆè´¹æ•°æ®ï¼‰ç­‰ã€‚
- Hash ç±»åž‹ï¼šç¼“å­˜å¯¹è±¡ã€è´­ç‰©è½¦ç­‰ã€‚
- Set ç±»åž‹ï¼šèšåˆè®¡ç®—ï¼ˆå¹¶é›†ã€äº¤é›†ã€å·®é›†ï¼‰åœºæ™¯ï¼Œæ¯”å¦‚ç‚¹èµžã€å…±åŒå…³æ³¨ã€æŠ½å¥–æ´»åŠ¨ç­‰ã€‚
- Zset ç±»åž‹ï¼šæŽ’åºåœºæ™¯ï¼Œæ¯”å¦‚æŽ’è¡Œæ¦œã€ç”µè¯å’Œå§“åæŽ’åºç­‰ã€‚

Redis åŽç»­ç‰ˆæœ¬åˆæ”¯æŒå››ç§æ•°æ®ç±»åž‹ï¼Œå®ƒä»¬çš„åº”ç”¨åœºæ™¯å¦‚ä¸‹ï¼š

-  BitMapï¼ˆ2.2 ç‰ˆæ–°å¢žï¼‰ï¼šäºŒå€¼çŠ¶æ€ç»Ÿè®¡çš„åœºæ™¯ï¼Œæ¯”å¦‚ç­¾åˆ°ã€åˆ¤æ–­ç”¨æˆ·ç™»å½•çŠ¶æ€ã€è¿žç»­ç­¾åˆ°ç”¨æˆ·æ€»æ•°ç­‰ï¼›
- HyperLogLogï¼ˆ2.8 ç‰ˆæ–°å¢žï¼‰ï¼šæµ·é‡æ•°æ®åŸºæ•°ç»Ÿè®¡çš„åœºæ™¯ï¼Œæ¯”å¦‚ç™¾ä¸‡çº§ç½‘é¡µ UV è®¡æ•°ç­‰ï¼›
- GEOï¼ˆ3.2 ç‰ˆæ–°å¢žï¼‰ï¼šå­˜å‚¨åœ°ç†ä½ç½®ä¿¡æ¯çš„åœºæ™¯ï¼Œæ¯”å¦‚æ»´æ»´å«è½¦ï¼›
- Streamï¼ˆ5.0 ç‰ˆæ–°å¢žï¼‰ï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œç›¸æ¯”äºŽåŸºäºŽ List ç±»åž‹å®žçŽ°çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæœ‰è¿™ä¸¤ä¸ªç‰¹æœ‰çš„ç‰¹æ€§ï¼šè‡ªåŠ¨ç”Ÿæˆå…¨å±€å”¯ä¸€æ¶ˆæ¯ IDï¼Œæ”¯æŒä»¥æ¶ˆè´¹ç»„å½¢å¼æ¶ˆè´¹æ•°æ®ã€‚

é’ˆå¯¹ Redis æ˜¯å¦é€‚åˆåšæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå…³é”®çœ‹ä½ çš„ä¸šåŠ¡åœºæ™¯ï¼š

- å¦‚æžœä½ çš„ä¸šåŠ¡åœºæ™¯è¶³å¤Ÿç®€å•ï¼Œå¯¹äºŽæ•°æ®ä¸¢å¤±ä¸æ•æ„Ÿï¼Œè€Œä¸”æ¶ˆæ¯ç§¯åŽ‹æ¦‚çŽ‡æ¯”è¾ƒå°çš„æƒ…å†µä¸‹ï¼ŒæŠŠ Redis å½“ä½œé˜Ÿåˆ—æ˜¯å®Œå…¨å¯ä»¥çš„ã€‚
- å¦‚æžœä½ çš„ä¸šåŠ¡æœ‰æµ·é‡æ¶ˆæ¯ï¼Œæ¶ˆæ¯ç§¯åŽ‹çš„æ¦‚çŽ‡æ¯”è¾ƒå¤§ï¼Œå¹¶ä¸”ä¸èƒ½æŽ¥å—æ•°æ®ä¸¢å¤±ï¼Œé‚£ä¹ˆè¿˜æ˜¯ç”¨ä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶å§ã€‚

---

å‚è€ƒèµ„æ–™ï¼š

- ã€ŠRedis æ ¸å¿ƒæŠ€æœ¯ä¸Žå®žæˆ˜ã€‹
- https://www.cnblogs.com/hunternet/p/12742390.html
- https://www.cnblogs.com/qdhxhz/p/15669348.html
- https://www.cnblogs.com/bbgs-xc/p/14376109.html
- http://kaito-kidd.com/2021/04/19/can-redis-be-used-as-a-queue/

---

æœ€æ–°çš„å›¾è§£æ–‡ç« éƒ½åœ¨å…¬ä¼—å·é¦–å‘ï¼Œåˆ«å¿˜è®°å…³æ³¨å“¦ï¼ï¼å¦‚æžœä½ æƒ³åŠ å…¥ç™¾äººæŠ€æœ¯äº¤æµç¾¤ï¼Œæ‰«ç ä¸‹æ–¹äºŒç»´ç å›žå¤ã€ŒåŠ ç¾¤ã€ã€‚

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost3@main/%E5%85%B6%E4%BB%96/%E5%85%AC%E4%BC%97%E5%8F%B7%E4%BB%8B%E7%BB%8D.png)
